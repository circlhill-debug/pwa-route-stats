<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<!-- Progressive Web App metadata -->
<meta name="theme-color" content="#2b7fff" />
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-180.png" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="RouteStats" />
<title>Route Stats ‚Äî Live Dashboard</title>
<style>
  :root{
    --bg:#0f1115; --card:#141821; --border:#22262e; --text:#e8e8ea; --muted:#9aa0aa; --brand:#2b7fff;
    --good:#7CE38B; --warn:#FFD27A; --bad:#FF8FA1
  }
  *{box-sizing:border-box}
  body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Inter,Segoe UI,Roboto,Arial,sans-serif }
  header{ border-bottom:1px solid var(--border); padding:14px 16px }
  .wrap{ max-width:1120px; margin:0 auto; padding:16px }
  h1{ margin:0; font-size:20px; letter-spacing:.3px }
  .grid{ display:grid; gap:12px }
  @media(min-width:1000px){ .grid-2{ grid-template-columns:1.1fr .9fr } }
  .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px }
  label{ font-size:13px; color:var(--muted) }
  input,select,textarea{ width:100%; padding:12px; background:transparent; border:1px solid var(--border); border-radius:10px; color:var(--text); font-size:15px }
  button{ background:var(--brand); color:#fff; border:0; border-radius:10px; padding:10px 14px; font-weight:700; cursor:pointer }
  button.ghost{ background:transparent; color:var(--text); border:1px solid var(--border) }
  small{ color:var(--muted) }
  table{ width:100%; border-collapse:collapse }
  th,td{ border-bottom:1px solid var(--border); padding:8px 6px; text-align:left }
  th{ color:var(--muted); font-weight:600 }
  .right{ text-align:right }
  .pill{ display:inline-flex; gap:8px; align-items:center; border:1px solid var(--border); padding:6px 8px; border-radius:999px; background:transparent }
  /* Ensure checkboxes render visibly inside pill labels */
  input[type="checkbox"]{ width:auto; height:auto; padding:0; margin:0 4px 0 0; accent-color: var(--brand); }
  .legend-swatch{ display:inline-block; width:10px; height:10px; border-radius:2px; margin-right:6px }
  .stat{ display:flex; flex-direction:column; gap:4px; padding:10px; border:1px solid var(--border); border-radius:12px; min-width:140px }
  .up{ color:var(--good) } .down{ color:var(--bad) } .warn{ color:var(--warn) }
  canvas{ background:transparent; border:1px solid var(--border); border-radius:10px; padding:8px; touch-action: manipulation; -webkit-tap-highlight-color: transparent }
  /* Slim sparkline override: no border/padding, minimal height */
  canvas.sparkline{ display:block; width:100%; border:none; padding:0; height:48px; max-height:48px; touch-action: manipulation; -webkit-tap-highlight-color: transparent }
  .sparkline-labels{ color:var(--muted); font-size:12px; margin-top:4px }
  .sparkline-summary{ color:var(--muted); font-size:12px; margin-top:4px }
  .fab{ position:fixed; right:16px; bottom:16px; z-index:10 }
  #diag{ position:sticky; top:0; z-index:999; background:#111; color:#ddd; font:12px/1.35 system-ui; padding:6px 10px; border-bottom:1px solid #222 }
  #diag b{ color:#fff }
  tr.light td{ background:linear-gradient(90deg, rgba(124,227,139,.07), transparent) }
  tr.heavy td{ background:linear-gradient(90deg, rgba(255,143,161,.10), transparent) }
  tr.typical td{ background:linear-gradient(90deg, rgba(255,210,122,.08), transparent) }
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
  dialog{ background:var(--card); color:var(--text); border:1px solid var(--border); border-radius:12px; padding:16px }

  /* Visibility + focus upgrades */
  input,select,textarea{
    background:#0b0f15;
    border:1px solid #303643;
    font-size:16px;
    caret-color:var(--brand);
  }
  input:hover,select:hover,textarea:hover{ border-color:#3d4554 }
  input:focus-visible,select:focus-visible,textarea:focus-visible{
    outline:2px solid var(--brand);
    outline-offset:0;
    border-color:var(--brand);
    box-shadow:0 0 0 3px rgba(43,127,255,.25);
    background:#0c1220;
  }
  ::placeholder{ color:#b7beca; opacity:1 }
  .card .grid > div:has(> input:focus-visible),
  .card .grid > div:has(> select:focus-visible),
  .card .grid > div:has(> textarea:focus-visible){
    background:#101726;
    border-radius:10px;
    padding:6px;
    transition:background .15s ease;
  }

  /* Save feedback */
  button.saving{ opacity:.7; cursor:wait }
  @keyframes savedFlash{
    0%{ box-shadow:0 0 0 0 rgba(43,127,255,.6) }
    100%{ box-shadow:0 0 0 14px rgba(43,127,255,0) }
  }
  button.savedFlash{ animation:savedFlash 600ms ease-out }

  /* Clickable results */
  #tbl tbody tr.rowLink{ cursor:pointer }
  #tbl tbody tr.rowLink:hover td{ background:rgba(43,127,255,.06) }
  /* Compact header buttons (e.g., Quick Entry) */
  button.btn-compact{ padding:4px 8px; font-size:12px; border-radius:999px }
</style>
</head>
<body>
<div id="diag">
  ROUTE STATS ¬∑ Supabase: <b id="dConn">‚Ä¶</b> ¬∑ Auth: <b id="dAuth">‚Ä¶</b> ¬∑ Write: <b id="dWrite">‚Äî</b>
</div>

<!-- Version tag -->
<div id="verTag" style="position:fixed;top:6px;right:12px;color:#9aa0aa;font-size:11px;z-index:9999;">v‚Äî</div>
<!-- USPS Evaluation summary (fixed) -->
<div id="uspsEvalTag" title="Click to edit USPS evaluation in Settings"
     style="position:fixed;top:26px;right:12px;z-index:9999;display:none">
  <span class="pill" style="font-size:11px;line-height:1.2;gap:6px;padding:6px 8px;cursor:pointer">
    <span id="evalRouteLabel">‚Äî</span>
    <span id="evalEvalCode" class="muted">‚Äî</span>
    <span id="evalBoxes" class="muted">‚Äî boxes</span>
    <span id="evalSalary" class="muted">‚Äî/yr</span>
    <span id="evalHours" class="muted">‚Äîh (‚Äî office)</span>
  </span>
  </div>
<header>
  <div class="wrap row" style="justify-content:space-between;align-items:flex-start;gap:8px;flex-wrap:wrap">
    <!-- CHANGED: dynamic date -->
    <div>
      <h1 style="margin-bottom:4px">üìà ROUTE STATS ‚Äî Live Dashboard ‚Äî <span id="headerDate">‚Äî</span></h1>
      <div id="headlineDigest" style="display:none;font-size:13px;color:var(--text);text-align:center;margin-top:6px">‚Äî</div>
      <div id="smartSummary" style="display:none;font-size:13px;color:var(--text);text-align:center;margin-top:6px">‚Äî</div>
      <div id="trendFactors" class="row" style="display:none;justify-content:center;gap:8px;margin-top:4px"></div>
      <div id="weekHeaviness" class="row" style="display:none;justify-content:center;gap:8px;margin-top:2px"></div>
    </div>
    <div class="row">
      <button id="signInBtn" class="ghost">Sign in</button>
      <button id="setPwBtn" class="ghost" title="Set/Change password for the current account">Set password</button>
      <button id="linkBtn" class="ghost">Link devices (magic link)</button>
      <button id="signOut" class="ghost">Sign out</button>
      <button id="btnSettings" class="ghost" title="Toggle feature flags">Settings</button>
      <button id="btnFocusMode" class="ghost" title="Show only snapshot tiles (collapse the rest)" style="display:none">Focus Mode: Off</button>
    </div>
  </div>
</header>

<main class="wrap grid grid-2">
  <!-- SNAPSHOT -->
  <section class="card" id="snapshotCard">
    <div class="row" style="justify-content:space-between;align-items:flex-start;flex-wrap:wrap">
      <div class="row" style="gap:8px;align-items:stretch">
        <div class="stat">
          <small>Expected End (today)</small>
          <strong id="expEnd" style="font-size:20px">‚Äî</strong>
          <small id="expMeta" style="color:var(--muted)">DOW avg ‚Äî</small>
        </div>
        <div class="stat">
          <small>Volume</small>
          <strong id="badgeVolume" style="font-size:20px">‚Äî</strong>
          <small class="muted">parcels + 0.33√óletters</small>
          <div id="helpVolume" style="display:none;margin-top:4px;font-size:12px;color:var(--muted)">‚Äî</div>
        </div>
        <div class="stat">
          <small>Route Eff.</small>
          <strong id="badgeRouteEff" style="font-size:20px">‚Äî</strong>
          <small class="muted">vs weekday baseline</small>
          <div id="helpRouteEff" style="display:none;margin-top:4px;font-size:12px;color:var(--muted)">‚Äî</div>
        </div>
        <div class="stat">
          <small>Overall</small>
          <strong id="badgeOverall" style="font-size:20px">‚Äî</strong>
          <small class="muted">office + route vs expected</small>
          <div id="helpOverall" style="display:none;margin-top:4px;font-size:12px;color:var(--muted)">‚Äî</div>
        </div>
        <!-- USPS tiles (moved up into primary snapshot row) -->
        <div class="stat" id="tileUspsRouteEff">
          <small>USPS Route Eff.</small>
          <div><strong id="uspsRouteEffVal">‚Äî</strong></div>
          <small class="muted">this week vs eval</small>
        </div>
        <div class="stat" id="tileUspsHourly">
          <small>Weekly $/h</small>
          <div><strong id="uspsHourlyRateVal">‚Äî</strong></div>
          <small class="muted">4w avg</small>
        </div>
      </div>
      <div class="row" style="gap:8px;align-items:stretch">
        <div class="stat" id="tileWkHours" style="cursor:pointer" tabindex="0" title="Click for weekly hours breakdown">
          <small>Hours (week)</small>
          <div><strong id="wkHours">‚Äî</strong> <span id="wkHoursDelta" class="pill">‚Äî</span></div>
        </div>
        <div class="stat" id="tileWkParcels" style="cursor:pointer" tabindex="0" title="Click for weekly parcels breakdown">
          <small>Parcels (week)</small>
          <div><strong id="wkParcels">‚Äî</strong> <span id="wkParcelsDelta" class="pill">‚Äî</span></div>
        </div>
        <div class="stat" id="tileWkLetters" style="cursor:pointer" tabindex="0" title="Click for weekly letters breakdown">
          <small>Letters (week)</small>
          <div><strong id="wkLetters">‚Äî</strong> <span id="wkLettersDelta" class="pill">‚Äî</span></div>
        </div>
      <!-- Advanced Weekly Metrics (Phase 1) ‚Äî moved above today's deltas -->
      <div class="row" id="trendPillsRow" style="gap:8px;align-items:stretch">
        <div class="stat" id="tileAdvHours" style="cursor:pointer" tabindex="0" title="Click for weighted daily hour deltas">
          <small>Weekly Hours Trend</small>
          <div><span id="advHoursTrend" class="pill">‚Äî</span></div>
          <small class="muted">day-by-day vs last week</small>
        </div>
        <div class="stat" id="tileAdvParcels" style="cursor:pointer" tabindex="0" title="Click for weighted daily parcel deltas">
          <small>Weekly Parcels Trend</small>
          <div><span id="advParcelsTrend" class="pill">‚Äî</span></div>
          <small class="muted">day-by-day vs last week</small>
        </div>
        <div class="stat" id="tileAdvLetters" style="cursor:pointer" tabindex="0" title="Click for weighted daily letter deltas">
          <small>Weekly Letters Trend</small>
          <div><span id="advLettersTrend" class="pill">‚Äî</span></div>
          <small class="muted">day-by-day vs last week</small>
        </div>
      </div>
      <!-- Today vs same-weekday pills -->
      <div class="stat">
        <small>Today Parcels Œî</small>
        <div><strong id="todayParcelsDelta">‚Äî</strong></div>
        <small class="muted">vs past same weekday (worked)</small>
      </div>
      <div class="stat">
        <small>Today Letters Œî</small>
        <div><strong id="todayLettersDelta">‚Äî</strong></div>
        <small class="muted">vs past same weekday (worked)</small>
      </div>
      <div class="stat">
        <small>Today Office Œî</small>
        <div><strong id="todayOfficeDelta">‚Äî</strong></div>
        <small class="muted">vs past same weekday (worked)</small>
      </div>
      </div>
      <!-- Heaviness (today) attribution -->
      <div id="todayHeaviness" class="row" style="display:none;gap:8px;flex-wrap:wrap;margin-top:6px"></div>
    <!-- Inline details panel for weekly hours breakdown (toggled on click) -->
    <div id="wkHoursDetails" style="display:none;margin-top:10px;border:1px solid var(--border);border-radius:10px;padding:10px">
      <div class="row" style="justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
        <h4 style="margin:0">Weekly Hours Breakdown</h4>
        <button id="closeWkHoursDetails" class="ghost">Close</button>
      </div>
      <small class="muted" style="color:var(--text)">Shows this week (Mon..today) vs last week (Mon..Sun). Œî% compares each weekday and the totals.</small>
      <div id="wkHoursDetailsBody" style="margin-top:8px;overflow:auto;border:1px solid var(--border);border-radius:10px">
        <!-- populated by script -->
      </div>
    </div>
    <!-- Inline details panel for weekly parcels breakdown -->
    <div id="wkParcelsDetails" style="display:none;margin-top:10px;border:1px solid var(--border);border-radius:10px;padding:10px">
      <div class="row" style="justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
        <h4 style="margin:0">Weekly Parcels Breakdown</h4>
        <button id="closeWkParcelsDetails" class="ghost">Close</button>
      </div>
      
      <div id="wkParcelsDetailsBody" style="margin-top:8px;overflow:auto;border:1px solid var(--border);border-radius:10px"></div>
    </div>
    <!-- Inline details panel for weekly letters breakdown -->
    <div id="wkLettersDetails" style="display:none;margin-top:10px;border:1px solid var(--border);border-radius:10px;padding:10px">
      <div class="row" style="justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
        <h4 style="margin:0">Weekly Letters Breakdown</h4>
        <button id="closeWkLettersDetails" class="ghost">Close</button>
      </div>
      
      <div id="wkLettersDetailsBody" style="margin-top:8px;overflow:auto;border:1px solid var(--border);border-radius:10px"></div>
    </div>
    <!-- Inline details panel for advanced Weekly Trend (Hours) -->
    <div id="advHoursDetails" style="display:none;margin-top:10px;border:1px solid var(--border);border-radius:10px;padding:10px">
      <div class="row" style="justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
        <h4 style="margin:0">Weekly Hours Trend ‚Äî Weighted daily deltas</h4>
        <button id="closeAdvHoursDetails" class="ghost">Close</button>
      </div>
      <small class="muted">Mon..today vs same weekday last week. Uses Weighted average (falls back to Cumulative if needed).</small>
      <div id="advHoursDetailsBody" style="margin-top:8px;overflow:auto;border:1px solid var(--border);border-radius:10px"></div>
    </div>
    <!-- Inline details panel for advanced Weekly Trend (Parcels) -->
    <div id="advParcelsDetails" style="display:none;margin-top:10px;border:1px solid var(--border);border-radius:10px;padding:10px">
      <div class="row" style="justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
        <h4 style="margin:0">Weekly Parcels Trend ‚Äî Weighted daily deltas</h4>
        <button id="closeAdvParcelsDetails" class="ghost">Close</button>
      </div>
      <small class="muted">Mon..today vs same weekday last week. Uses Weighted average (falls back to Cumulative if needed).</small>
      <div id="advParcelsDetailsBody" style="margin-top:8px;overflow:auto;border:1px solid var(--border);border-radius:10px"></div>
    </div>
    <!-- Inline details panel for advanced Weekly Trend (Letters) -->
    <div id="advLettersDetails" style="display:none;margin-top:10px;border:1px solid var(--border);border-radius:10px;padding:10px">
      <div class="row" style="justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
        <h4 style="margin:0">Weekly Letters Trend ‚Äî Weighted daily deltas</h4>
        <button id="closeAdvLettersDetails" class="ghost">Close</button>
      </div>
      <small class="muted">Mon..today vs same weekday last week. Uses Weighted average (falls back to Cumulative if needed).</small>
      <div id="advLettersDetailsBody" style="margin-top:8px;overflow:auto;border:1px solid var(--border);border-radius:10px"></div>
    </div>
  </section>

  <!-- FORM -->
  <section class="card" id="addEntryCard">
    <h3 style="margin:0 0 8px 0">Add Entry</h3>

    <div class="row" style="margin:6px 0 10px 0; gap:8px; flex-wrap:wrap">
      <button id="btnStartNow" class="ghost">Start (now)</button>
      <button id="btnStreetNow" class="ghost">Hit Street (now)</button>
      <button id="btnClockNow" class="ghost">Clock Out (now)</button>
      <!-- Quick actions -->
      <button id="btnEditLast" class="ghost">Edit last entry</button>
      <button id="btnDeleteDay" class="ghost" style="border-color:#ff8fa1;color:#ff8fa1">Delete this day</button>
      <button id="btnUndoDelete" class="ghost" style="display:none">Undo delete</button>
    </div>

    <div class="grid" style="grid-template-columns:repeat(2,1fr);gap:10px">
      <div><label>Date</label><input id="date" type="date"></div>

      <div>
        <label>Route</label>
        <input id="route" type="text" value="R1" readonly>
      </div>

      <div><label>Start (defaults 08:00)</label><div class="row"><input id="start" type="time" value="08:00"><button id="btnStartNow2" class="ghost">Now</button></div></div>
      <div><label>Hit Street</label><div class="row"><input id="departTime" type="time" placeholder="--:--"><button id="btnStreetNow2" class="ghost">Now</button></div></div>

      <div><label>Return (optional)</label><div class="row"><input id="returnTime" type="time" placeholder="--:--"><button id="btnReturnNow" class="ghost">Now</button></div></div>
      <div><label>Clock Out</label><div class="row"><input id="end" type="time" placeholder="--:--"><button id="btnClockNow2" class="ghost">Now</button></div></div>

      <div><label>Parcels</label><input id="parcels" type="number" min="0" value="0"></div>
      <div><label>Letters</label><input id="letters" type="number" min="0" value="0"></div>
      <div><label>Miles</label><input id="miles" type="number" step="0.1" min="0" value="53"></div>

      <div>
        <label>Weather</label>
        <div class="row">
          <select id="weather" style="min-width:160px">
            <option value="">‚Äî</option>
            <option>‚òÄÔ∏è Sunny</option>
            <option>‚õÖ Partly Cloudy</option>
            <option>üåßÔ∏è Rain</option>
            <option>‚ùÑÔ∏è Snow</option>
            <option>üí® Windy</option>
            <option>üå´Ô∏è Fog</option>
            <option>Other</option>
          </select>
          <select id="temp" title="Temp (¬∞F)" style="min-width:110px">
            <option value="">Temp (¬∞F)</option>
            <option>20</option><option>25</option><option>30</option><option>35</option>
            <option>40</option><option>45</option><option>50</option><option>55</option>
            <option>60</option><option>65</option><option>70</option><option>75</option>
            <option>80</option><option>85</option><option>90</option><option>95</option>
          </select>
        </div>
      </div>

      <div>
        <label>Boxholders</label>
        <select id="boxholders" title="x1 = one boxholder; x2 = two; x3 = three+">
          <option value="">‚Äî</option>
          <option value="x1">x1</option>
          <option value="x2">x2</option>
          <option value="x3">x3</option>
        </select>
      </div>

      <div><label>Mood</label><select id="mood"><option value="">‚Äî</option><option>üî• dialed in</option><option>üôÇ good</option><option>üòê meh</option><option>ü•µ cooked</option><option>üåßÔ∏è soggy</option><option>üõë off</option></select></div>
      <div style="grid-column:1/-1"><label>Notes</label><textarea id="notes" rows="2" placeholder="Anything notable‚Ä¶"></textarea></div>

      <div class="row" style="grid-column:1/-1;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
        <div class="row" style="gap:8px;align-items:center">
          <label class="pill"><input id="offDay" type="checkbox"> Off day</label>
          <label class="pill" title="If an off day is a holiday, the next day's baseline will include two days to avoid skew"><input id="holiday" type="checkbox"> Holiday (observed)</label>
        </div>
        <div class="row"><span class="pill"><small>Office:</small> <b id="officeH">‚Äî</b></span><span class="pill"><small>Route:</small> <b id="routeH">‚Äî</b></span><span class="pill"><small>Total:</small> <b id="totalH">‚Äî</b></span></div>
        <div class="row"><button id="save">Save</button></div>
      </div>
    </div>
  </section>

  <!-- CHARTS -->
  <section class="card" id="dowCard"><h3 style="margin:0 0 8px 0">Average Hours by Weekday</h3><canvas id="dowChart" height="180"></canvas></section>
  <section class="card" id="parcelsOverTimeCard"><h3 style="margin:0 0 8px 0">Parcels Over Time (worked days)</h3><canvas id="parcelsChart" height="180"></canvas></section>
  <section class="card" id="lettersOverTimeCard"><h3 style="margin:0 0 8px 0">Letters Over Time (worked days)</h3><canvas id="lettersChart" height="180"></canvas></section>

  <!-- Quick Filter (Phase 3) -->
  <section class="card" id="quickFilterCard">
    <div class="row" style="justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
      <h3 style="margin:0">Quick Filter</h3>
      <select id="qfSelect" style="min-width:140px">
        <option value="all">All days</option>
        <option value="1">Monday</option>
        <option value="2">Tuesday</option>
        <option value="3">Wednesday</option>
        <option value="4">Thursday</option>
        <option value="5">Friday</option>
        <option value="6">Saturday</option>
        <option value="0">Sunday</option>
      </select>
    </div>
    <div class="row" id="qfStats" style="gap:8px;flex-wrap:wrap;margin-top:8px">
      <!-- pills populated by script -->
    </div>
      <div id="qfViz" style="margin-top:8px">
      <div class="row" id="qfMetrics" style="gap:8px;flex-wrap:wrap;margin-bottom:6px;align-items:center">
        <label class="pill" title="Toggle all metrics on/off"><input id="qfAllMetrics" type="checkbox" checked> All</label>
        <label class="pill"><span class="legend-swatch" style="background: var(--brand)"></span><input id="qfShowParcels" type="checkbox" checked> Parcels</label>
        <label class="pill"><span class="legend-swatch" style="background: var(--warn)"></span><input id="qfShowLetters" type="checkbox" checked> Letters</label>
        <label class="pill"><span class="legend-swatch" style="background: var(--good)"></span><input id="qfShowHours"   type="checkbox" checked> Hours</label>
        <span class="pill" style="gap:6px"><small>Last</small>
          <select id="qfLastN" style="min-width:80px">
            <option value="8">8</option>
            <option value="12" selected>12</option>
            <option value="20">20</option>
          </select>
        </span>
        <label class="pill" title="Show faint 0/50/100 guide when normalized"><input id="qfShowRuler" type="checkbox"> Ruler</label>
        <span id="qfNormBadge" class="pill" style="display:none;border-color:var(--brand);color:var(--brand)" title="Values are normalized (0‚Äì100) for comparability">Normalized</span>
        <span id="qfDaysBadge" class="pill" title="Number of filtered days" style="display:none"></span>
      </div>
      <canvas id="qfSpark" class="sparkline" style="height:64px;max-height:64px"></canvas>
      <div id="qfText" class="sparkline-labels">‚Äî</div>
    </div>
  </section>

  <!-- Mix Compare (Baseline-aware) -->
  <section class="card" id="mixVizCard" style="display:none">
    <div class="row" style="justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
      <h3 style="margin:0">Weekly Compare</h3>
      <button id="mixCompareBtn" class="ghost" type="button">Details</button>
    </div>
    <div class="sparkline-labels">This week vs last (Mon..today vs last Mon..Sun)</div>
    <canvas id="weekOverlay" class="sparkline" style="margin-top:4px;height:72px;max-height:72px"></canvas>
    <div id="mixText" class="sparkline-labels">‚Äî</div>
    <div id="mixEff" class="sparkline-labels">‚Äî</div>
    <div id="mixCompareDetails" class="sparkline-summary" style="display:none; margin-top:6px">‚Äî</div>
    <canvas id="mixDrift" class="sparkline" style="margin-top:8px"></canvas>
    <div id="mixDriftText" class="sparkline-labels">‚Äî</div>
  </section>

  <!-- Office Time Compare -->
  <section class="card" id="officeCompareCard" style="grid-column:1/-1; display:none">
    <h3 style="margin:0 0 6px 0">Office Time Compare</h3>
    <div class="sparkline-labels">This week (Mon..today) vs last week (Mon..Sun)</div>
    <canvas id="officeOverlay" class="sparkline" style="margin-top:4px;height:72px;max-height:72px"></canvas>
    <div id="officeSummary" class="sparkline-labels">‚Äî</div>
  </section>

  

  <!-- Monthly Glance (preview) ‚Äî behind feature flag -->
  <section class="card" id="monthlyGlanceCard" style="grid-column:1/-1; display:none">
    <h3 style="margin:0 0 8px 0">Monthly Glance (preview)</h3>
    <small class="muted">Last 4 weeks (Mon..Sun). Charts render when available; shows text fallback otherwise.</small>
    <div class="grid" style="margin-top:8px; gap:8px">
      <div>
        <label>Hours</label>
        <div id="mgHours" class="row" style="color:var(--muted)">‚Äî</div>
      </div>
      <div>
        <label>Parcels</label>
        <div id="mgParcels" class="row" style="color:var(--muted)">‚Äî</div>
      </div>
      <div>
        <label>Letters</label>
        <div id="mgLetters" class="row" style="color:var(--muted)">‚Äî</div>
      </div>
    </div>
  </section>

  <!-- TABLE -->
  <section class="card" id="recentEntriesCard" style="grid-column:1/-1">
    <div class="row" style="justify-content:space-between;gap:10px;flex-wrap:wrap">
      <h3 style="margin:0">Recent Entries</h3>
      <div class="row" style="gap:8px">
        <input id="searchBox" type="search" placeholder="Search date, mood, weather, notes‚Ä¶" style="min-width:240px">
        <button id="exportCsv" class="ghost">Export CSV (All)</button>
        <button id="exportCsvFiltered" class="ghost">Export CSV (Filtered)</button>
        <input id="importFile" type="file" accept=".csv,text/csv" style="display:none">
        <button id="importCsv" class="ghost">Import CSV</button>
        <button id="showUid" class="ghost" title="Show current user id">Show UID</button>
      </div>
    </div>
    <div style="max-height:360px;overflow:auto;border:1px solid var(--border);border-radius:10px">
      <table id="tbl"><thead><tr>
        <th>Date</th><th>Route</th><th>Status</th><th class="right">Office (h)</th><th class="right">Route (h)</th><th class="right">Total (h)</th><th class="right">Parcels</th><th class="right">Letters</th><th class="right">Miles</th><th>Weather</th>
      </tr></thead><tbody></tbody></table>
    </div>
  </section>
</main>

<!-- Magic link dialog -->
<dialog id="linkDlg">
  <form method="dialog" class="grid" style="min-width:320px;gap:10px">
    <h3 style="margin:0">Link devices</h3>
    <small>Enter your email, then tap the magic link in your inbox on each device.</small>
    <input id="email" type="email" placeholder="you@example.com" required>
    <div class="row" style="justify-content:flex-end;gap:8px"><button class="ghost" value="cancel">Cancel</button><button id="sendLink">Send link</button></div>
  </form>
</dialog>

<!-- Email + Password dialog -->
<dialog id="pwDlg">
  <form method="dialog" class="grid" style="min-width:320px;gap:10px">
    <h3 style="margin:0">Sign in</h3>
    <input id="loginEmail" type="email" placeholder="Email" autocomplete="username" required>
    <input id="loginPass"  type="password" placeholder="Password" autocomplete="current-password" required>
    <div class="row" style="justify-content:flex-end;gap:8px">
      <button class="ghost" value="cancel">Cancel</button>
      <button id="doLogin">Sign In</button>
      <button id="doSignup" class="ghost" type="button" title="Create a new account">Create Account</button>
    </div>
    <small id="authMsg"></small>
  </form>
</dialog>

<!-- NEW: Set Password dialog -->
<dialog id="setPwDlg">
  <form method="dialog" class="grid" style="min-width:320px;gap:10px">
    <h3 style="margin:0">Set a new password</h3>
    <input id="newPass"  type="password" placeholder="New password (6+ chars)" required>
    <input id="newPass2" type="password" placeholder="Confirm password" required>
    <div class="row" style="justify-content:flex-end;gap:8px">
      <button class="ghost" value="cancel">Cancel</button>
      <button id="doSetPw">Save</button>
    </div>
    <small id="setPwMsg"></small>
  </form>
</dialog>

<!-- Settings / Feature Flags dialog -->
<dialog id="settingsDlg">
  <form method="dialog" class="grid" style="min-width:320px;gap:10px">
    <h3 style="margin:0">Settings</h3>
    <!-- Feature flags -->
    <label class="pill"><input id="flagWeekdayTicks" type="checkbox"> Show weekday + short date on line charts</label>
    <label class="pill"><input id="flagProgressivePills" type="checkbox"> Progressive color pills for deltas</label>
    <label class="pill"><input id="flagMonthlyGlance" type="checkbox"> Monthly Glance (preview): 4-week stacked sparklines</label>
    <label class="pill"><input id="flagHolidayAdjust" type="checkbox"> Holiday adjustments (carry Monday into Tuesday)
    </label>
    <label class="pill"><input id="flagTrendPills" type="checkbox"> Show Weekly Trend pills (power users)</label>
    <label class="pill"><input id="flagSameRangeTotals" type="checkbox"> Compare weekly totals: Mon..today vs last Mon..today</label>
    <label class="pill"><input id="flagHeadlineDigest" type="checkbox"> Show headline digest (Wed evenings)</label>
    <label class="pill"><input id="flagSmartSummary" type="checkbox"> Smart summary (rule-based)</label>
    
    <label class="pill"><input id="flagBaselineCompare" type="checkbox"> Use baseline-normalized compare (2-week weekday avg)</label>
    <label class="pill"><input id="flagCollapsedUi" type="checkbox"> Collapsed dashboard (experimental)</label>
    <label class="pill"><input id="flagQuickEntry" type="checkbox"> Quick Entry (experimental)</label>
    <label class="pill"><input id="flagUspsEval" type="checkbox"> Show USPS Evaluation summary (fixed tag)</label>

    <!-- USPS Evaluation configuration -->
    <div style="border-top:1px solid var(--border);padding-top:8px;margin-top:4px">
      <h4 style="margin:0 0 6px 0">USPS Evaluation</h4>
      <small class="muted">Used for comparison metrics; stored locally.</small>
      <div class="grid" style="grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
        <div>
          <label>Route label</label>
          <input id="evalRouteId" placeholder="e.g., R1" />
        </div>
        <div>
          <label>Evaluation code</label>
          <input id="evalCode" placeholder="e.g., 44K" />
        </div>
        <div>
          <label>Boxes (deliveries)</label>
          <input id="evalBoxesIn" type="number" min="0" step="1" placeholder="e.g., 670" />
        </div>
        <div>
          <label>Stops</label>
          <input id="evalStopsIn" type="number" min="0" step="1" placeholder="optional" />
        </div>
        <div>
          <label>Expected hours/day</label>
          <input id="evalHoursIn" type="number" min="0" step="0.1" placeholder="e.g., 9.4" />
        </div>
        <div>
          <label>Expected office hours/day</label>
          <input id="evalOfficeHoursIn" type="number" min="0" step="0.1" placeholder="e.g., 2.0" />
        </div>
        <div>
          <label>Annual salary ($)</label>
          <input id="evalSalaryIn" type="number" min="0" step="100" placeholder="e.g., 68000" />
        </div>
      </div>
    </div>

    <!-- Vacation Mode configuration -->
    <div style="border-top:1px solid var(--border);padding-top:8px;margin-top:4px">
      <h4 style="margin:0 0 6px 0">Vacation Mode</h4>
      <small class="muted">Exclude entries in a date range from all metrics.</small>
      <div class="row" style="gap:8px;margin-top:8px;flex-wrap:wrap;align-items:center">
        <label class="pill"><input id="vacEnabled" type="checkbox"> Enable</label>
        <span class="pill" style="gap:6px"><small>From</small> <input id="vacFrom" type="date"></span>
        <span class="pill" style="gap:6px"><small>To</small> <input id="vacTo" type="date"></span>
      </div>
    </div>
    <div class="row" style="justify-content:flex-end;gap:8px">
      <button class="ghost" value="cancel">Close</button>
      <button id="saveSettings">Save</button>
    </div>
    <div style="border-top:1px solid var(--border);padding-top:8px;margin-top:8px">
      <small class="muted">Maintenance</small>
      <div class="row" style="gap:8px;margin-top:6px">
        <button id="forceRefreshBtn" class="ghost" title="Force update service worker and clear caches">Force Refresh (update + clear cache)</button>
      </div>
      <small class="muted">Use if updates don‚Äôt appear due to caching.</small>
    </div>
    <small class="muted">Flags are stored locally (this device only).</small>
  </form>
</dialog>

<button class="fab" id="fab">+ Add Entry</button>

<!-- Prefer local vendored libraries; fall back to CDN -->
<script src="vendor/luxon.min.js"></script>
<script src="vendor/chart.umd.js"></script>
<script src="vendor/supabase.js"></script>
<script src="https://unpkg.com/luxon@3/build/global/luxon.min.js"></script>
<!-- Chart.js intentionally not loaded statically to avoid parse errors on blocked/truncated networks. Charts are optional. -->
<script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script>
  // If libs failed to load, show a clear banner with next step
  (function(){
    function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
    ready(function(){
      var missingCore=[]; if(!window.luxon) missingCore.push('Luxon'); if(!window.supabase) missingCore.push('Supabase');
      if(missingCore.length){
        var div=document.createElement('div');
        div.style.cssText='position:fixed;left:0;right:0;bottom:0;background:#c62828;color:#fff;padding:10px 14px;z-index:99999;font:14px/1.4 system-ui';
        div.textContent='Missing libraries: '+missingCore.join(', ')+'. Run "Fetch Vendor Libraries.command" to download local copies, then reload.';
        document.body.appendChild(div);
      }
      if(!window.Chart){
        console.warn('Chart.js missing ‚Äî charts disabled. Everything else should work.');
      }
    });
  })();
  </script>
<script>
  // Global error handler to surface issues in the UI
  (function(){
    window.addEventListener('error', function(e){
      try{
        var div=document.createElement('div');
        div.style.cssText='position:fixed;left:0;right:0;top:0;background:#b00020;color:#fff;padding:10px 14px;z-index:100000;font:13px/1.4 system-ui';
        var loc = '';
        if (e && (e.filename || e.lineno)) {
          loc = ' (' + (e.filename||'inline') + ':' + (e.lineno||'?') + ':' + (e.colno||'?') + ')';
        }
        div.textContent='JavaScript error: ' + (e && e.message ? e.message : 'unknown') + loc;
        document.body.appendChild(div);
        console.error('[RouteStats] error', e);
      }catch(_){ /* ignore */ }
    }, true);
  })();
</script>
<script>
  // ==== SUPABASE CONFIG ====
  console.log('[RouteStats] boot start');
  const SUPABASE_URL  = 'https://ouwkdtiixkaydrtfdhnh.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im91d2tkdGlpeGtheWRydGZkaG5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwMDc0NDksImV4cCI6MjA3MDU4MzQ0OX0.KI-dYG5_A8jvPEHSog3wlnLbIGYIHQR_4ztXHL2SzIg';
  const ZONE = 'America/Detroit';

  // === Feature Flags (localStorage) ===
  const FLAG_KEY = 'routeStats.flags.v1';
  const EVAL_KEY = 'routeStats.uspsEval.v1';
  const VACAY_KEY = 'routeStats.vacation.v1';
  const BASELINE_KEY = 'routeStats.baseline.v1';
  function loadFlags(){
    try{ return Object.assign({ weekdayTicks:true, progressivePills:false, monthlyGlance:true, holidayAdjustments:true, trendPills:false, sameRangeTotals:true, quickFilter:true, headlineDigest:false, smartSummary:true, mixViz:true, baselineCompare:true, collapsedUi:false, focusMode:false, quickEntry:false, uspsEval:true }, JSON.parse(localStorage.getItem(FLAG_KEY)||'{}')); }
    catch(_){ return { weekdayTicks:true, progressivePills:false, monthlyGlance:true, holidayAdjustments:true, trendPills:false, sameRangeTotals:true, quickFilter:true, headlineDigest:false, smartSummary:true, mixViz:true, baselineCompare:true, collapsedUi:false, focusMode:false, quickEntry:false, uspsEval:true }; }
  }
  function loadEval(){
    try{
      return Object.assign({ routeId:'R1', evalCode:'44K', boxes:670, stops:null, hoursPerDay:9.4, officeHoursPerDay:2.0, annualSalary:68000 }, JSON.parse(localStorage.getItem(EVAL_KEY)||'{}'));
    }catch(_){
      return { routeId:'R1', evalCode:'44K', boxes:670, stops:null, hoursPerDay:9.4, officeHoursPerDay:2.0, annualSalary:68000 };
    }
  }
  function saveEval(cfg){ localStorage.setItem(EVAL_KEY, JSON.stringify(cfg||{})); }
  let USPS_EVAL = loadEval();

  // Vacation Mode config
  function loadVacation(){
    try{
      return Object.assign({ enabled:false, ranges:[] }, JSON.parse(localStorage.getItem(VACAY_KEY)||'{}'));
    }catch(_){ return { enabled:false, ranges:[] }; }
  }
  function saveVacation(cfg){ try{ localStorage.setItem(VACAY_KEY, JSON.stringify(cfg||{enabled:false,ranges:[]})); }catch(_){ } }
  let VACATION = loadVacation();

  function dateInRangeISO(iso, fromIso, toIso){
    try{
      if (!iso || !fromIso || !toIso) return false;
      const d = DateTime.fromISO(iso, {zone:ZONE}).startOf('day');
      const a = DateTime.fromISO(fromIso, {zone:ZONE}).startOf('day');
      const b = DateTime.fromISO(toIso, {zone:ZONE}).endOf('day');
      return d >= a && d <= b;
    }catch(_){ return false; }
  }
  function isVacationDate(iso){
    try{
      const cfg = VACATION || loadVacation();
      if (!cfg || !cfg.enabled || !Array.isArray(cfg.ranges)) return false;
      return cfg.ranges.some(r=> dateInRangeISO(iso, r.from, r.to));
    }catch(_){ return false; }
  }
  function filterRowsForView(rows){
    try{
      const cfg = VACATION || loadVacation();
      if (!cfg || !cfg.enabled || !Array.isArray(cfg.ranges) || cfg.ranges.length===0) return rows||[];
      return (rows||[]).filter(r=> !isVacationDate(r.work_date));
    }catch(_){ return rows||[]; }
  }

  // Weekly baselines (frozen per week): average of previous 2 completed weeks per weekday
  function ensureWeeklyBaselines(rows){
    try{
      const now = DateTime.now().setZone(ZONE);
      const weekStartIso = startOfWeekMonday(now).toISODate();
      const savedRaw = localStorage.getItem(BASELINE_KEY);
      if (savedRaw){
        const saved = JSON.parse(savedRaw);
        if (saved && saved.weekStart === weekStartIso) return saved;
      }
      const startLast = startOfWeekMonday(now.minus({weeks:1}));
      const endLast   = endOfWeekSunday(now.minus({weeks:1}));
      const startPrev = startOfWeekMonday(now.minus({weeks:2}));
      const endPrev   = endOfWeekSunday(now.minus({weeks:2}));
      const inRange=(r,from,to)=>{ const d=DateTime.fromISO(r.work_date,{zone:ZONE}); return d>=from && d<=to; };
      const worked = rows.filter(r=> r.status!=='off');
      const W1 = worked.filter(r=> inRange(r,startLast,endLast));
      const W2 = worked.filter(r=> inRange(r,startPrev,endPrev));
      const byW = (arr,fn)=>{
        const out = Array.from({length:7},()=>[]);
        arr.forEach(r=>{ const d=DateTime.fromISO(r.work_date,{zone:ZONE}); const idx=(d.weekday+6)%7; out[idx].push(fn(r)||0); });
        return out;
      };
      const pW1 = byW(W1, r=> +r.parcels||0), pW2 = byW(W2, r=> +r.parcels||0);
      const lW1 = byW(W1, r=> +r.letters||0), lW2 = byW(W2, r=> +r.letters||0);
      const mean = arr=> arr.length? (arr.reduce((a,b)=>a+b,0)/arr.length) : null;
      const parcels = Array.from({length:7},(_,i)=> mean([...(pW1[i]||[]), ...(pW2[i]||[])]));
      const letters = Array.from({length:7},(_,i)=> mean([...(lW1[i]||[]), ...(lW2[i]||[])]));
      const snap = { weekStart: weekStartIso, parcels, letters };
      localStorage.setItem(BASELINE_KEY, JSON.stringify(snap));
      return snap;
    }catch(_){ return null; }
  }
  function getWeeklyBaselines(){
    try{ return JSON.parse(localStorage.getItem(BASELINE_KEY)||'null'); }catch(_){ return null; }
  }

  // Anchor baselines (on the fly): median of last N completed weeks per weekday (default 8)
  function computeAnchorBaselines(rows, weeks=8){
    try{
      const now = DateTime.now().setZone(ZONE);
      const worked = rows.filter(r=> r.status!=='off');
      // Collect per-week per-weekday values for parcels/letters across last N completed weeks
      const weeksArr = [];
      for (let w=1; w<=weeks; w++){
        const s = startOfWeekMonday(now.minus({weeks:w}));
        const e = endOfWeekSunday(now.minus({weeks:w}));
        weeksArr.push({s,e});
      }
      const perW = (fn)=>{
        const arrs = Array.from({length:7},()=>[]);
        for (const wk of weeksArr){
          const set = worked.filter(r=>{ const d=DateTime.fromISO(r.work_date,{zone:ZONE}); return d>=wk.s && d<=wk.e; });
          const tmp = Array.from({length:7},()=>0);
          set.forEach(r=>{ const d=DateTime.fromISO(r.work_date,{zone:ZONE}); const idx=(d.weekday+6)%7; tmp[idx]+= (fn(r)||0); });
          for (let i=0;i<7;i++) arrs[i].push(tmp[i]);
        }
        // median per weekday
        const med = arrs.map(a=>{
          const b=[...a].sort((x,y)=>x-y); const n=b.length; if(!n) return null; const mid=Math.floor(n/2);
          return n%2? b[mid] : (b[mid-1]+b[mid])/2;
        });
        return med;
      };
      return {
        parcels: perW(r=> +r.parcels||0),
        letters: perW(r=> +r.letters||0)
      };
    }catch(_){ return null; }
  }
  function saveFlags(f){ localStorage.setItem(FLAG_KEY, JSON.stringify(f)); }
  let FLAGS = loadFlags();

  // === Helpers ===
  const $ = id => document.getElementById(id);
  const DateTime = luxon.DateTime;
  const dConn=$('dConn'), dAuth=$('dAuth'), dWrite=$('dWrite');

  // NEW: set live header date + version tag
  (function(){
    const d = DateTime.now().setZone(ZONE);
    const el = document.getElementById('headerDate');
    if (el) el.textContent = d.toFormat('MMM d, yyyy');
    const ver = document.getElementById('verTag');
    if (ver) ver.textContent = 'v' + d.toFormat('yyyy-MM-dd');
  })();

  function renderUspsEvalTag(){
    try{
      const tag = document.getElementById('uspsEvalTag'); if (!tag) return;
      if (!FLAGS.uspsEval){ tag.style.display='none'; return; }
      const cfg = USPS_EVAL || loadEval();
      $('evalRouteLabel').textContent = cfg.routeId || '‚Äî';
      $('evalEvalCode').textContent = cfg.evalCode || '‚Äî';
      $('evalBoxes').textContent = (cfg.boxes!=null? cfg.boxes : '‚Äî') + ' boxes';
      $('evalSalary').textContent = (cfg.annualSalary!=null? ('$'+Number(cfg.annualSalary).toLocaleString()) : '‚Äî') + '/yr';
      const hp = (cfg.hoursPerDay!=null? cfg.hoursPerDay : '‚Äî');
      const oh = (cfg.officeHoursPerDay!=null? cfg.officeHoursPerDay : '‚Äî');
      $('evalHours').textContent = `${hp}h (${oh} office)`;
      tag.style.display='block';
      tag.onclick = ()=> document.getElementById('btnSettings')?.click();
    }catch(_){ /* ignore */ }
  }
  // initial render
  renderUspsEvalTag();

  function todayStr(){ return DateTime.now().setZone(ZONE).toISODate(); }
  function hhmmNow(){ const d = DateTime.now().setZone(ZONE); return `${String(d.hour).padStart(2,'0')}:${String(d.minute).padStart(2,'0')}`; }
  function dowIndex(dateStr){ return DateTime.fromFormat(dateStr,'yyyy-MM-dd',{zone:ZONE}).weekday % 7; }
  function startOfWeekMonday(dt){ const w = dt.weekday; const shift = (w+6)%7; return dt.startOf('day').minus({days:shift}); }
  function endOfWeekSunday(dt){ return startOfWeekMonday(dt).plus({days:6}).endOf('day'); }

  // NEW: Moon phase emoji helper
  // Improved Moon phase calc (better epoch)
function moonPhaseEmoji(dateStr) {
  const d = DateTime.fromISO(dateStr, { zone: ZONE });
  const lp = 2551442.8; // synodic month (sec)
  // Reference new moon: Jan 6, 2000 at 18:14 UTC
  const newMoon = DateTime.fromISO("2000-01-06T18:14:00Z").toSeconds();
  const phase = ((d.toSeconds() - newMoon) % lp + lp) % lp / lp;

  if (phase < 0.03 || phase > 0.97) return "üåë";   // New
  if (phase < 0.25) return "üåí";                  // Waxing crescent
  if (phase < 0.27) return "üåì";                  // First quarter
  if (phase < 0.48) return "üåî";                  // Waxing gibbous
  if (phase < 0.52) return "üåï";                  // Full
  if (phase < 0.75) return "üåñ";                  // Waning gibbous
  if (phase < 0.77) return "üåó";                  // Last quarter
  return "üåò";                                    // Waning crescent
}

  function diffHours(d, t1, t2){
    if(!t1||!t2) return null;
    const a = DateTime.fromISO(`${d}T${t1}`, { zone: ZONE });
    const b = DateTime.fromISO(`${d}T${t2}`, { zone: ZONE });
    let h = (b.toMillis()-a.toMillis())/3.6e6; if(h<0) h+=24; return Math.round(h*100)/100;
  }
  function routeEndTime(){ return ($('returnTime').value || $('end').value || ''); }

  // Supabase
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON, { auth:{ persistSession:true }});

  // === Handle auth callbacks (incl. password recovery links) ===
  (async () => {
    try {
      const { data, error } = await sb.auth.getSessionFromUrl();
      // If this was a password recovery link, prompt to set a new password
      if (!error && data?.session && /type=recovery/i.test(location.hash)) {
        const p1 = prompt('Enter a new password (6+ characters)');
        if (p1 && p1.length >= 6) {
          const { error: uerr } = await sb.auth.updateUser({ password: p1 });
          if (uerr) alert('Update failed: ' + uerr.message);
          else alert('Password updated. You can now sign in normally.');
        } else {
          alert('Password must be at least 6 characters.');
        }
        // clean the URL
        window.history.replaceState({}, document.title, window.location.pathname);
      } else if (!error && data?.session) {
        // generic callback: clean hash
        window.history.replaceState({}, document.title, window.location.pathname);
      }
    } catch (e) {
      console.warn('Auth callback error', e);
    }
  })();

  // Connectivity + session bootstrap
  (async ()=>{ try{ await fetch(SUPABASE_URL,{mode:'no-cors'}); dConn.textContent='Connected'; }catch{ dConn.textContent='Error'; }})();
  (async function ensureSession(){
    const { data:{ session } } = await sb.auth.getSession();
    if(!session){ await sb.auth.signInAnonymously().catch(()=>{}); } // you can remove this later if you like
    const { data:{ user } } = await sb.auth.getUser();
    dAuth.textContent = user? 'Session' : 'No session';
  })();

  // Magic link
  const linkBtn=$('linkBtn'), linkDlg=$('linkDlg'), sendLink=$('sendLink'), email=$('email');
  linkBtn.addEventListener('click', ()=> linkDlg.showModal());
  sendLink.addEventListener('click', async (e)=>{
    e.preventDefault();
    const redirectTo = location.origin + location.pathname;
    const { error } = await sb.auth.signInWithOtp({ email: email.value, options:{ emailRedirectTo: redirectTo } });
    if (error) alert(error.message); else { alert('Check your email for the magic link.'); linkDlg.close(); }
  });
  $('signOut').addEventListener('click', ()=> sb.auth.signOut().then(()=>location.reload()));

  // === Email + Password auth ===
  const signInBtn = $('signInBtn');
  const pwDlg     = $('pwDlg');
  const loginEmail= $('loginEmail');
  const loginPass = $('loginPass');
  const doLogin   = $('doLogin');
  const doSignup  = $('doSignup');
  const authMsg   = $('authMsg');

  signInBtn?.addEventListener('click', ()=> {
    authMsg.textContent = '';
    loginEmail.value = loginEmail.value || '';
    loginPass.value = '';
    pwDlg.showModal();
  });

  doLogin?.addEventListener('click', async (e)=>{
    e.preventDefault();
    authMsg.textContent = 'Signing in‚Ä¶';
    const { error } = await sb.auth.signInWithPassword({
      email: (loginEmail.value||'').trim(),
      password: loginPass.value||''
    });
    if (error) {
      if (/Email not confirmed/i.test(error.message)) authMsg.textContent = 'Email not confirmed. Use reset link or check your inbox.';
      else if (/Invalid login credentials/i.test(error.message)) authMsg.textContent = 'Invalid email or password. Try Reset or Create Account.';
      else authMsg.textContent = 'Error: ' + error.message;
      return;
    }
    authMsg.textContent = 'Signed in!';
    pwDlg.close();
    const rows = await fetchEntries(); allRows=rows; renderTable(applySearch(allRows)); buildCharts(allRows); buildSnapshot(allRows); buildMonthlyGlance(allRows); buildMixViz(allRows); buildSmartSummary(allRows); buildTrendingFactors(allRows); buildOfficeCompare(allRows); buildHeavinessToday(allRows); buildWeekHeaviness(allRows); buildUspsTiles(allRows);
  });

  doSignup?.addEventListener('click', async ()=>{
    authMsg.textContent = 'Creating account‚Ä¶';
    const { error } = await sb.auth.signUp({
      email: (loginEmail.value||'').trim(),
      password: loginPass.value||''
    });
    authMsg.textContent = error
      ? ('Error: ' + error.message)
      : 'Account created. If email confirmation is on, check your inbox, then Sign In.';
  });

  // === Set password for the CURRENT logged-in user ===
  const setPwBtn = $('setPwBtn');
  const setPwDlg = $('setPwDlg');
  const newPass  = $('newPass');
  const newPass2 = $('newPass2');
  const setPwMsg = $('setPwMsg');
  const doSetPw  = $('doSetPw');

  setPwBtn?.addEventListener('click', ()=> {
    setPwMsg.textContent = '';
    newPass.value = '';
    newPass2.value = '';
    setPwDlg.showModal();
  });

  doSetPw?.addEventListener('click', async (e)=>{
    e.preventDefault();
    const p1 = newPass.value || '';
    const p2 = newPass2.value || '';
    if (p1.length < 6) { setPwMsg.textContent = 'Password must be at least 6 characters.'; return; }
    if (p1 !== p2)     { setPwMsg.textContent = 'Passwords do not match.'; return; }
    setPwMsg.textContent = 'Updating‚Ä¶';
    const { error } = await sb.auth.updateUser({ password: p1 });
    if (error) { setPwMsg.textContent = 'Error: ' + error.message; return; }
    setPwMsg.textContent = 'Password set! You can now sign in anywhere.';
    setTimeout(()=> setPwDlg.close(), 600);
  });

  // === Settings dialog (Feature Flags) ===
  const settingsDlg = document.getElementById('settingsDlg');
  const btnSettings = document.getElementById('btnSettings');
  const flagWeekdayTicks = document.getElementById('flagWeekdayTicks');
  const flagProgressivePills = document.getElementById('flagProgressivePills');
  const flagMonthlyGlance = document.getElementById('flagMonthlyGlance');
  const flagHolidayAdjust = document.getElementById('flagHolidayAdjust');
  const flagTrendPills = document.getElementById('flagTrendPills');
  const flagSameRangeTotals = document.getElementById('flagSameRangeTotals');
  const flagHeadlineDigest = document.getElementById('flagHeadlineDigest');
  const flagMixViz = document.getElementById('flagMixViz');
  const flagBaselineCompare = document.getElementById('flagBaselineCompare');
  const flagCollapsedUi = document.getElementById('flagCollapsedUi');
  const flagQuickEntry = document.getElementById('flagQuickEntry');
  const flagSmartSummary = document.getElementById('flagSmartSummary');
  const flagUspsEval = document.getElementById('flagUspsEval');
  // USPS Eval inputs
  const evalRouteId = document.getElementById('evalRouteId');
  const evalCode    = document.getElementById('evalCode');
  const evalBoxesIn = document.getElementById('evalBoxesIn');
  const evalStopsIn = document.getElementById('evalStopsIn');
  const evalHoursIn = document.getElementById('evalHoursIn');
  const evalOfficeHoursIn = document.getElementById('evalOfficeHoursIn');
  const evalSalaryIn = document.getElementById('evalSalaryIn');
  // Vacation mode inputs
  const vacEnabled = document.getElementById('vacEnabled');
  const vacFrom    = document.getElementById('vacFrom');
  const vacTo      = document.getElementById('vacTo');
  const saveSettings = document.getElementById('saveSettings');

  btnSettings?.addEventListener('click', ()=>{
    // populate from FLAGS
    flagWeekdayTicks.checked = !!FLAGS.weekdayTicks;
    flagProgressivePills.checked = !!FLAGS.progressivePills;
    if (flagMonthlyGlance) flagMonthlyGlance.checked = !!FLAGS.monthlyGlance;
    if (flagHolidayAdjust) flagHolidayAdjust.checked = !!FLAGS.holidayAdjustments;
    if (flagTrendPills) flagTrendPills.checked = !!FLAGS.trendPills;
    if (flagSameRangeTotals) flagSameRangeTotals.checked = !!FLAGS.sameRangeTotals;
    if (flagHeadlineDigest) flagHeadlineDigest.checked = !!FLAGS.headlineDigest;
    if (flagMixViz) flagMixViz.checked = !!FLAGS.mixViz;
    if (flagBaselineCompare) flagBaselineCompare.checked = !!FLAGS.baselineCompare;
    if (flagCollapsedUi) flagCollapsedUi.checked = !!FLAGS.collapsedUi;
    if (flagQuickEntry) flagQuickEntry.checked = !!FLAGS.quickEntry;
    if (flagSmartSummary) flagSmartSummary.checked = !!FLAGS.smartSummary;
    if (flagUspsEval) flagUspsEval.checked = !!FLAGS.uspsEval;
    // populate USPS eval fields
    try{
      const cfg = USPS_EVAL || loadEval();
      if (evalRouteId) evalRouteId.value = cfg.routeId || '';
      if (evalCode)    evalCode.value    = cfg.evalCode || '';
      if (evalBoxesIn) evalBoxesIn.value = (cfg.boxes!=null? cfg.boxes : '');
      if (evalStopsIn) evalStopsIn.value = (cfg.stops!=null? cfg.stops : '');
      if (evalHoursIn) evalHoursIn.value = (cfg.hoursPerDay!=null? cfg.hoursPerDay : '');
      if (evalOfficeHoursIn) evalOfficeHoursIn.value = (cfg.officeHoursPerDay!=null? cfg.officeHoursPerDay : '');
      if (evalSalaryIn) evalSalaryIn.value = (cfg.annualSalary!=null? cfg.annualSalary : '');
    }catch(_){ }
    // populate Vacation Mode
    try{
      const v = VACATION || loadVacation();
      if (vacEnabled) vacEnabled.checked = !!v.enabled;
      if (vacFrom)    vacFrom.value = (v.ranges && v.ranges[0]?.from) || '';
      if (vacTo)      vacTo.value   = (v.ranges && v.ranges[0]?.to)   || '';
    }catch(_){ }
    settingsDlg.showModal();
  });

  saveSettings?.addEventListener('click', (e)=>{
    e.preventDefault();
    FLAGS.weekdayTicks = !!flagWeekdayTicks.checked;
    FLAGS.progressivePills = !!flagProgressivePills.checked;
    if (flagMonthlyGlance) FLAGS.monthlyGlance = !!flagMonthlyGlance.checked;
    if (flagHolidayAdjust) FLAGS.holidayAdjustments = !!flagHolidayAdjust.checked;
    if (flagTrendPills) FLAGS.trendPills = !!flagTrendPills.checked;
    if (flagSameRangeTotals) FLAGS.sameRangeTotals = !!flagSameRangeTotals.checked;
    if (flagHeadlineDigest) FLAGS.headlineDigest = !!flagHeadlineDigest.checked;
    if (flagMixViz) FLAGS.mixViz = !!flagMixViz.checked;
    if (flagBaselineCompare) FLAGS.baselineCompare = !!flagBaselineCompare.checked;
    if (flagCollapsedUi) FLAGS.collapsedUi = !!flagCollapsedUi.checked;
    if (flagQuickEntry) FLAGS.quickEntry = !!flagQuickEntry.checked;
    if (flagSmartSummary) FLAGS.smartSummary = !!flagSmartSummary.checked;
    if (flagUspsEval) FLAGS.uspsEval = !!flagUspsEval.checked;
    // read USPS eval fields
    try{
      USPS_EVAL = {
        routeId: (evalRouteId?.value||'').trim() || 'R1',
        evalCode: (evalCode?.value||'').trim() || '44K',
        boxes:    evalBoxesIn?.value!=='' ? +evalBoxesIn.value : null,
        stops:    evalStopsIn?.value!=='' ? +evalStopsIn.value : null,
        hoursPerDay: evalHoursIn?.value!=='' ? +evalHoursIn.value : null,
        officeHoursPerDay: evalOfficeHoursIn?.value!=='' ? +evalOfficeHoursIn.value : null,
        annualSalary: evalSalaryIn?.value!=='' ? +evalSalaryIn.value : null
      };
      saveEval(USPS_EVAL);
    }catch(_){ }
    // read Vacation Mode
    try{
      VACATION = {
        enabled: !!(vacEnabled && vacEnabled.checked),
        ranges: (vacFrom && vacFrom.value && vacTo && vacTo.value) ? [{ from: vacFrom.value, to: vacTo.value }] : []
      };
      saveVacation(VACATION);
    }catch(_){ }
    saveFlags(FLAGS);
    settingsDlg.close();
    // Re-render visuals affected by flags
    buildCharts(allRows||[]);
    buildSnapshot(allRows||[]);
    buildMonthlyGlance(allRows||[]);
    buildQuickFilter(allRows||[]);
    buildMixViz(allRows||[]);
    buildHeadlineDigest(allRows||[]);
    buildSmartSummary(allRows||[]);
    buildTrendingFactors(allRows||[]);
    buildOfficeCompare(allRows||[]);
    buildHeavinessToday(allRows||[]);
    buildWeekHeaviness(allRows||[]);
    buildUspsTiles(allRows||[]);
    renderUspsEvalTag();
    
    applyTrendPillsVisibility();
    applyCollapsedUi();
  });

  // Force Refresh: update SW, clear caches, reload
  document.getElementById('forceRefreshBtn')?.addEventListener('click', async (e)=>{
    e.preventDefault();
    try{
      try{ const keys = await caches.keys(); await Promise.all(keys.map(k => caches.delete(k))); }catch(_){ }
      if ('serviceWorker' in navigator){
        const reg = await navigator.serviceWorker.getRegistration();
        try{ await reg?.update(); }catch(_){ }
        try{ reg?.waiting?.postMessage({ type:'SKIP_WAITING' }); }catch(_){ }
      }
    } finally {
      setTimeout(()=> location.reload(), 200);
    }
  });

  function applyTrendPillsVisibility(){
    const ids = ['tileAdvHours','tileAdvParcels','tileAdvLetters'];
    const show = !!(FLAGS && FLAGS.trendPills);
    ids.forEach(id=>{ const el = document.getElementById(id); if (el) el.style.display = show ? '' : 'none'; });
    const row = document.getElementById('trendPillsRow');
    if (row) row.style.display = show ? '' : 'none';
  }

  sb.auth.onAuthStateChange((_evt, session) => {
    const authed = !!session;
    const signOutBtn = $('signOut');
    if (signOutBtn) signOutBtn.style.display = authed ? 'inline-block' : 'none';
    dAuth.textContent = authed ? 'Session' : 'No session';
  });

  // ====== APP LOGIC (unchanged beyond tiny UX tweaks) ======

  function dowIndex(dateStr){ return DateTime.fromFormat(dateStr,'yyyy-MM-dd',{zone:ZONE}).weekday % 7; }

  function routeEndTime(){ return ($('returnTime').value || $('end').value || ''); }

  const date=$('date'), route=$('route'), start=$('start'), end=$('end'), departTime=$('departTime'), returnTime=$('returnTime');
  const parcels=$('parcels'), letters=$('letters'), miles=$('miles'), mood=$('mood'), notes=$('notes');
  const weather=$('weather'), temp=$('temp'), boxholders=$('boxholders'), holiday=$('holiday');
  const offDay=$('offDay');
  const officeH=$('officeH'), routeH=$('routeH'), totalH=$('totalH');
  const expEnd=$('expEnd'), expMeta=$('expMeta');
  const badgeVolume=$('badgeVolume'), badgeRouteEff=$('badgeRouteEff'), badgeOverall=$('badgeOverall');
  const dConnEl=$('dConn'), dAuthEl=$('dAuth'), dWriteEl=$('dWrite');

  badgeVolume.title   = 'Volume = parcels + 0.33√óletters (rank vs recent, 0‚Äì10)';
  badgeRouteEff.title = 'Route Efficiency = today‚Äôs street hours vs typical for this weekday (0‚Äì10)';
  badgeOverall.title  = 'Overall = total hours vs expected (weekday avg)';

  date.value = todayStr();
  route.value = 'R1';

  function computeBreakdown(){
    if (offDay.checked){ officeH.textContent='0.00'; routeH.textContent='0.00'; totalH.textContent='0.00'; return 0; }
    const d=date.value; const s=start.value||'08:00';
    const off=diffHours(d, s, departTime.value);
    let rte  = diffHours(d, departTime.value, routeEndTime());
    if (rte==null && routeEndTime()){
      const span = diffHours(d, s, routeEndTime());
      if (span!=null && off!=null) rte = Math.max(0, +(span - off).toFixed(2));
    }
    const tot=Math.max(0, (off??0)+(rte??0));
    officeH.textContent = off!=null? off.toFixed(2) : '‚Äî';
    routeH.textContent  = rte!=null? rte.toFixed(2) : '‚Äî';
    totalH.textContent  = (off!=null||rte!=null)? tot.toFixed(2) : '‚Äî';
    const diag=$('diag');
    if (diag){ diag.innerHTML = `ROUTE STATS ¬∑ Supabase: <b id="dConn">${dConn.textContent}</b> ¬∑ Auth: <b id="dAuth">${dAuth.textContent}</b> ¬∑ Write: <b id="dWrite">${dWrite.textContent}</b> ¬∑ <b>Off:</b> ${off ?? '‚Äî'}h ¬∑ <b>Route:</b> ${rte ?? '‚Äî'}h ¬∑ <b>Total:</b> ${((off??0)+(rte??0)).toFixed(2)}h`; }
    return tot;
  }

  // Boxholder adjustment helpers (does not change stored times; used for efficiency metrics only)
  function parseBoxholdersValue(v){
    if (!v) return 0;
    const s = String(v).toLowerCase();
    if (s==='x1' || /light/.test(s)) return 1;
    if (s==='x2' || /medium/.test(s)) return 2;
    if (s==='x3' || /heavy/.test(s)) return 3;
    if (/none/.test(s)) return 0;
    return 0;
  }
  function boxholderAdjMinutes(valOrRow){
    const v = (valOrRow && typeof valOrRow==='object') ? valOrRow.boxholders : valOrRow;
    const n = parseBoxholdersValue(v);
    // Defaults: x1=+30min, x2=+45min (second adds +15), x3=+60min
    return n===1?30 : n===2?45 : n>=3?60 : 0;
  }

  function setNow(el){ el.value=hhmmNow(); computeBreakdown(); }
  $('btnStartNow').addEventListener('click',()=>{ if(!start.value) setNow(start); });
  $('btnStreetNow').addEventListener('click',()=> setNow(departTime));
  $('btnClockNow').addEventListener('click',()=>{ setNow(end); if(!returnTime.value){ returnTime.value = end.value; } });
  $('btnStartNow2').addEventListener('click',()=> setNow(start));
  $('btnStreetNow2').addEventListener('click',()=> setNow(departTime));
  $('btnReturnNow').addEventListener('click',()=> setNow(returnTime));
  $('btnClockNow2').addEventListener('click',()=>{ setNow(end); if(!returnTime.value){ returnTime.value = end.value; } });

  offDay.addEventListener('change', ()=>{ if(offDay.checked){ end.value=hhmmNow(); parcels.value=letters.value=miles.value=0; mood.value='üõë off'; computeBreakdown(); }});
  ;[date,start,departTime,returnTime,end,parcels,letters,miles,offDay,weather,temp,boxholders].forEach(el=> el.addEventListener('input', computeBreakdown));

  document.addEventListener('keydown', (e)=>{
    const mod = e.metaKey || e.ctrlKey; if(!mod) return; const k = e.key.toLowerCase();
    if(k==='s'){ e.preventDefault(); $('save')?.click(); }
    else if(k==='d'){ e.preventDefault(); $('btnEditLast')?.click(); }
    else if(e.key==='Backspace'){ e.preventDefault(); $('btnDeleteDay')?.click(); }
  });

  function weatherString(){
    const parts=[]; if(weather?.value) parts.push(weather.value); if(temp?.value) parts.push(`${temp.value}¬∞F`); if(boxholders?.value) parts.push(`Box: ${boxholders.value}`); if (holiday?.checked) parts.push('Holiday');
    return parts.length? parts.join(' ¬∑ ') : null;
  }

  function collectPayload(userId){
    const d=date.value; const s=start.value||'08:00';
    const offRaw = diffHours(d, s, departTime.value);
    let rteRaw   = diffHours(d, departTime.value, routeEndTime());
    if (rteRaw==null && routeEndTime()){
      const span = diffHours(d, s, routeEndTime());
      if (span!=null && offRaw!=null) rteRaw = Math.max(0, +(span - offRaw).toFixed(2));
    }
    const off = offDay.checked ? 0 : offRaw;
    const rte = offDay.checked ? 0 : rteRaw;
    const tot = offDay.checked ? 0 : ((off??0)+(rte??0));
    return {
      user_id:userId,
      work_date:d,
      route:'R1',
      start_time:   offDay.checked ? null : (s||null),
      end_time:     offDay.checked ? null : (end.value || null),
      hours:        offDay.checked ? 0 : (tot||null),
      parcels:      offDay.checked ? 0 : (+parcels.value||0),
      letters:      offDay.checked ? 0 : (+letters.value||0),
      miles:        offDay.checked ? 0 : (+miles.value||0),
      mood:         offDay.checked ? 'üõë off' : (mood.value||null),
      notes:        notes.value||null,
      status:       offDay.checked ? 'off' : 'worked',
      office_start: s||null,
      depart_time:  departTime.value||null,
      return_time:  returnTime.value||null,
      office_minutes: offDay.checked ? 0 : (offRaw!=null? +offRaw.toFixed(2): null),
      route_minutes:  offDay.checked ? 0 : (rteRaw!=null? +rteRaw.toFixed(2): null),
      weather_json: weatherString()
    };
  }

  function fillForm(r){
    start.value       = r.start_time || '08:00';
    end.value         = r.end_time   || '';
    departTime.value  = r.depart_time || '';
    returnTime.value  = r.return_time || '';
    parcels.value     = r.parcels || 0;
    letters.value     = r.letters || 0;
    miles.value       = r.miles   || 0;
    mood.value        = r.mood    || '';
    notes.value       = r.notes   || '';
    offDay.checked    = (r.status === 'off');

    const raw = r.weather_json || '';
    if (!raw){ if(temp) temp.value=''; if(boxholders) boxholders.value=''; if(holiday) holiday.checked=false; weather.value=''; }
    else {
      const parts = String(raw).split('¬∑').map(s=>s.trim());
      let w='', t='', b=''; let hol=false;
      for (const p of parts){
        if (/¬∞F$/.test(p)) t = p.replace('¬∞F','').trim();
        else if (/^Box:/i.test(p)) b = p.split(':').slice(1).join(':').trim();
        else if (/^Holiday$/i.test(p)) hol = true;
        else w = p;
      }
      weather.value = w || '';
      if (temp) temp.value = t || '';
      if (boxholders) boxholders.value = b || '';
      if (holiday) holiday.checked = !!hol;
    }
    try { computeBreakdown(); } catch(_){}
  }

  let editingKey = null; let lastDeleted = null; const btnUndoDelete = $('btnUndoDelete');
  function showUndo(show){ if(!btnUndoDelete) return; btnUndoDelete.style.display = show ? 'inline-block' : 'none'; }

  const searchBox = $('searchBox'); let allRows = [];
  function applySearch(rows){
    const q = (searchBox.value||'').trim().toLowerCase(); if(!q) return rows;
    return rows.filter(r=>{
      const fields=[ r.work_date, r.status, r.mood, r.weather_json, r.notes, String(r.parcels||''), String(r.letters||''), String(r.miles||'') ];
      return fields.some(v=> String(v||'').toLowerCase().includes(q));
    });
  }

  async function loadByDate(){
    editingKey = null; const { data:{ user } } = await sb.auth.getUser(); if(!user) return; const d=date.value; if(!d) return;
    const { data, error } = await sb.from('entries').select('*').eq('user_id', user.id).eq('work_date', d).limit(1).maybeSingle();
    if (error && error.code !== 'PGRST116') { console.error(error); return; }
    const saveBtn=$('save'); saveBtn.classList.remove('ghost');
    if (data) { editingKey = { user_id:user.id, work_date:d }; fillForm(data); saveBtn.textContent='Update'; }
    else { saveBtn.textContent='Save'; }
  }
  date.addEventListener('change', loadByDate);

  (function replaceSave(){
    const btn=$('save'); const clone=btn.cloneNode(true); btn.parentNode.replaceChild(clone,btn);
    clone.addEventListener('click', async ()=>{
      const { data:{ user } } = await sb.auth.getUser(); if (!user) { alert('No session. Try Link devices or refresh.'); return; }
      const payload = collectPayload(user.id); let error;
      try{
        // Guard against duplicates: replace all rows for this user/date with a single fresh payload
        const { data: existing, error: findErr } = await sb
          .from('entries').select('work_date', { count: 'exact', head: false })
          .eq('user_id', user.id).eq('work_date', payload.work_date);
        if (findErr) console.warn('find existing failed', findErr);
        const exists = Array.isArray(existing) && existing.length > 0;
        if (exists){
          const { error: delErr } = await sb.from('entries').delete().eq('user_id', user.id).eq('work_date', payload.work_date);
          if (delErr) { error = delErr; throw delErr; }
          const { error: insErr } = await sb.from('entries').insert(payload);
          if (insErr) { error = insErr; throw insErr; }
        } else {
          const { error: insErr } = await sb.from('entries').insert(payload);
          if (insErr) { error = insErr; throw insErr; }
        }
      }catch(e){ error = e; }
      dWrite.textContent = error ? 'Failed' : 'OK'; if (error){ alert(error.message); return; }
      clone.textContent = 'Update'; clone.disabled = true; clone.classList.add('saving','savedFlash');
      setTimeout(()=>{ clone.disabled=false; clone.classList.remove('saving'); }, 400); setTimeout(()=> clone.classList.remove('savedFlash'), 700);
      const rows = await fetchEntries(); allRows = rows; renderTable(applySearch(allRows)); buildCharts(allRows); buildSnapshot(allRows); buildMonthlyGlance(allRows);
      editingKey = { user_id:user.id, work_date:date.value }; clone.classList.remove('ghost');
    });
  })();

  $('btnEditLast')?.addEventListener('click', async ()=>{
    const rows = await fetchEntries(); if(!rows.length){ alert('No entries yet.'); return; }
    const latest = rows[0]; $('date').value = latest.work_date; await loadByDate(); window.scrollTo({ top:0, behavior:'smooth' });
  });

  $('btnDeleteDay')?.addEventListener('click', async ()=>{
    const { data:{ user } } = await sb.auth.getUser(); if(!user){ alert('No session. Try Link devices.'); return; }
    const d = $('date').value; if(!d){ alert('Pick a date first.'); return; }
    const { data: rowToDelete, error: fetchErr } = await sb.from('entries').select('*').eq('user_id',user.id).eq('work_date',d).maybeSingle();
    if(fetchErr && fetchErr.code!=='PGRST116'){ alert(fetchErr.message); return; }
    if(!rowToDelete){ alert('No entry exists for this date.'); return; }
    if(!confirm(`Delete your entry for ${d}? This cannot be undone (unless you press Undo).`)) return;
    const { error } = await sb.from('entries').delete().eq('user_id',user.id).eq('work_date',d); if(error){ alert(error.message); return; }
    lastDeleted = rowToDelete; showUndo(true);
    $('notes').value=''; parcels.value=0; letters.value=0; miles.value=53; offDay.checked=false; start.value='08:00'; end.value=''; departTime.value=''; returnTime.value=''; mood.value=''; weather.value=''; if(temp) temp.value=''; if(boxholders) boxholders.value=''; computeBreakdown();
    const rows = await fetchEntries(); allRows=rows; renderTable(applySearch(allRows)); buildCharts(allRows); buildSnapshot(allRows); buildMonthlyGlance(allRows); alert(`Deleted ${d}. You can Undo now.`);
  });

  btnUndoDelete?.addEventListener('click', async ()=>{
    if(!lastDeleted){ showUndo(false); return; }
    dWrite.textContent='‚Äî'; const { error } = await sb.from('entries').insert(lastDeleted);
    if(error){ alert('Undo failed: '+error.message); return; }
    const rows = await fetchEntries(); allRows=rows; renderTable(applySearch(allRows)); buildCharts(allRows); buildSnapshot(allRows); buildMonthlyGlance(allRows);
    alert(`Restored ${lastDeleted.work_date}.`); $('date').value = lastDeleted.work_date; await loadByDate(); lastDeleted=null; showUndo(false);
  });

  async function fetchEntries(){
    const { data:{ user } } = await sb.auth.getUser(); if(!user) return [];
    const { data, error } = await sb.from('entries').select('*').eq('user_id',user.id).order('work_date',{ascending:false}).limit(365);
    if(error){ console.error(error); return []; } return data;
  }

  function classifyRow(total, avg){ if(total==null||avg==null) return ''; const diff=(total-avg)/avg; if(diff<=-0.15) return 'light'; if(diff>=0.15) return 'heavy'; return 'typical'; }

  function renderTable(rows){
    const tbody=document.querySelector('#tbl tbody'); tbody.innerHTML='';
    const byDow=Array.from({length:7},()=>[]);
    rows.forEach(r=>{ if(r.status==='off') return; const h=Number(r.hours||0); const d=dowIndex(r.work_date); if(h>0) byDow[d].push(h); });
    const avgByDow=byDow.map(list=> list.length? (list.reduce((a,b)=>a+b,0)/list.length) : null);

    for(const r of rows){
      const tot=Number(r.hours||0)||null;
      const offH=(r.office_minutes!=null)? Number(r.office_minutes).toFixed(2):'';
      const rteH=(r.route_minutes!=null)? Number(r.route_minutes).toFixed(2):'';

      // NEW: weekday shorthand + moon phase
      const dObj = DateTime.fromISO(r.work_date, { zone: ZONE });
      const dowShort = dObj.toFormat('ccc').charAt(0); // M, T, W, T, F, S, S
      const moon = moonPhaseEmoji(r.work_date);

      const d=dowIndex(r.work_date);
      const avg=avgByDow[d];
      const cls=classifyRow(tot,avg);

      const tr=document.createElement('tr');
      tr.classList.add('rowLink');
      if(cls) tr.classList.add(cls);
      tr.dataset.date=r.work_date;
      tr.tabIndex=0;

      tr.innerHTML = `<td>${r.work_date} (${dowShort}) ${moon}</td><td>R1</td><td>${r.status||'worked'}</td>
        <td class="right">${offH}</td><td class="right">${rteH}</td><td class="right">${tot!=null? tot.toFixed(2):''}</td>
        <td class="right">${r.parcels||0}</td><td class="right">${r.letters||0}</td><td class="right">${r.miles||0}</td>
        <td>${r.weather_json||''}</td>`;
      tbody.appendChild(tr);
    }
  }

  // Dynamic version tag with today's date (for exports)
  const VERSION_TAG = (function(){ try{ return 'v' + DateTime.now().setZone(ZONE).toFormat('yyyy-MM-dd'); }catch(_){ return 'v-current'; } })();
  function toCsv(rows){
    const headers=['work_date','route','status','start_time','depart_time','return_time','end_time','hours','office_minutes','route_minutes','parcels','letters','miles','mood','notes','weather_json','created_at'];
    const lines=[headers.join(',')];
    for(const r of rows){
      const vals=headers.map(h=>{ let v; if(h==='route') v='R1'; else v=r[h]; if(v==null) return ''; const s=String(v).replace(/"/g,'""'); return /[",\n]/.test(s)? '"'+s+'"': s; });
      lines.push(vals.join(','));
    }
    return lines.join('\n');
  }

  $('exportCsv').addEventListener('click', async ()=>{ const rows = allRows.length? allRows : await fetchEntries(); const blob=new Blob([toCsv(rows)],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`route-stats-all_${VERSION_TAG}.csv`; a.click(); });
  $('exportCsvFiltered').addEventListener('click', async ()=>{ const rows = applySearch(allRows.length? allRows : await fetchEntries()); const blob=new Blob([toCsv(rows)],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`route-stats-filtered_${VERSION_TAG}.csv`; a.click(); });

  const showUidBtn=$('showUid');
  showUidBtn?.addEventListener('click', async ()=>{ const { data:{ user } } = await sb.auth.getUser(); if(!user){ alert('No session. Use Link devices.'); return; } alert(`Current user id (account key):\n${user.id}\n\nEntries are filtered by this id.`); });

  const importFile=$('importFile'); $('importCsv')?.addEventListener('click', ()=> importFile.click());
  importFile?.addEventListener('change', async ()=>{
    const file=importFile.files?.[0]; if(!file) return; const text=await file.text();
    const lines=text.split(/\r?\n/).filter(Boolean); if(lines.length<2){ alert('CSV is empty'); return; }
    const headers=lines[0].split(',').map(h=> h.trim().replace(/^"|"$/g,'')); const idx=(n)=> headers.indexOf(n);
    const splitCsv=(row)=> row.split(/,(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)/); const unq=(v)=> (/^".*"$/.test(v)? v.slice(1,-1).replace(/""/g,'"') : v);
    const { data:{ user } } = await sb.auth.getUser(); if(!user){ alert('No session. Use Link devices.'); return; }
    const rows=[]; for(let i=1;i<lines.length;i++){ const cols=splitCsv(lines[i]); const get=(name)=> unq(cols[idx(name)] ?? ''); const r={ user_id:user.id, work_date:get('work_date'), route:'R1', status:get('status')||'worked', start_time:get('start_time')||null, depart_time:get('depart_time')||null, return_time:get('return_time')||null, end_time:get('end_time')||null, hours:+(get('hours')||0)||null, office_minutes:get('office_minutes')||null, route_minutes:get('route_minutes')||null, parcels:+(get('parcels')||0)||0, letters:+(get('letters')||0)||0, miles:+(get('miles')||0)||0, mood:get('mood')||null, notes:get('notes')||null, weather_json:get('weather_json')||null }; if(r.work_date) rows.push(r); }
    if(!rows.length){ alert('No rows detected'); return; }
    const chunk=200; for(let i=0;i<rows.length;i+=chunk){ const slice=rows.slice(i,i+chunk); const { error } = await sb.from('entries').insert(slice); if(error){ alert('Import failed: '+error.message); return; } }
    const fresh=await fetchEntries(); allRows=fresh; renderTable(applySearch(allRows)); buildCharts(allRows); buildSnapshot(allRows); buildMonthlyGlance(allRows); buildMixViz(allRows); buildSmartSummary(allRows); buildTrendingFactors(allRows); buildOfficeCompare(allRows); buildUspsTiles(allRows); alert(`Imported ${rows.length} rows into this account.`);
  });

  let dowChart, parcelsChart, lettersChart; function destroyCharts(){ [dowChart,parcelsChart,lettersChart].forEach(c=>c&&c.destroy()); }
  // Helper: make tapping the canvas set the nearest tooltip (mobile-friendly)
  function enableChartTap(chart, canvas){
    if (!chart || !canvas) return;
    const handler = (ev)=>{
      try{
        const rect = canvas.getBoundingClientRect();
        const cx = (ev.touches && ev.touches[0] ? ev.touches[0].clientX : ev.clientX);
        const cy = (ev.touches && ev.touches[0] ? ev.touches[0].clientY : ev.clientY);
        const x = cx - rect.left, y = cy - rect.top;
        const points = chart.getElementsAtEventForMode(ev, 'nearest', { intersect:false }, true);
        if (points && points.length){
          const a = [{ datasetIndex: points[0].datasetIndex, index: points[0].index }];
          if (chart.setActiveElements) chart.setActiveElements(a);
          if (chart.tooltip && chart.tooltip.setActiveElements) chart.tooltip.setActiveElements(a, { x, y });
          chart.update();
        }
      }catch(_){ /* ignore */ }
    };
    ['click','touchstart','pointerdown'].forEach(t => canvas.addEventListener(t, handler, { passive: true }));
  }

  function buildCharts(rows){
    rows = filterRowsForView(rows||[]);
    // If Chart.js isn't available, skip chart rendering so the rest of the app works
    if (!window.Chart) { console.warn('Chart.js missing ‚Äî skipping charts'); return; }
    destroyCharts(); const workRows=rows.filter(r=>r.status!=='off');
    const byDow=Array.from({length:7},()=>({h:0,c:0}));
    for(const r of workRows){ const h=Number(r.hours||0); if(h>0){ const d=dowIndex(r.work_date); byDow[d].h+=h; byDow[d].c++; } }
    // Monday-first labels and data ordering (Mon..Sun)
    const dowLabels=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    const order=[1,2,3,4,5,6,0];
    const perDow=byDow.map(x=> x.c? +(x.h/x.c).toFixed(2):0);
    const dowData=order.map(i=> perDow[i]);
    dowChart=new Chart(document.getElementById('dowChart'),{
      type:'bar',
      data:{ labels:dowLabels, datasets:[{label:'Avg Total Hours',data:dowData}] },
      options:{ responsive:true, plugins:{ legend:{ display:false } } }
    });
    const sortedWork=[...workRows].sort((a,b)=> a.work_date.localeCompare(b.work_date)); const labels=sortedWork.map(r=> r.work_date);
    const parcelsCanvas = document.getElementById('parcelsChart');
    parcelsChart=new Chart(parcelsCanvas,{
      type:'line',
      data:{
        labels,
        datasets:[{ label:'Parcels', data: sortedWork.map(r=> +r.parcels||0), pointRadius:3, pointHoverRadius:8, pointHitRadius:16 }]
      },
      options: {
        responsive: true,
        interaction: { mode: 'nearest', intersect: false },
        events: ['mousemove','mouseout','click','touchstart','touchmove','touchend'],
        animation: { duration: 0 },
        plugins: {
          legend: { display: false },
          tooltip: {
            animation: { duration: 0 },
            callbacks: {
              title: (items) => {
                const iso = items?.[0]?.label;
                const d = DateTime.fromISO(iso, { zone: ZONE });
                return d.toFormat("cccc ‚Ä¢ MMM d, yyyy");
              }
            }
          }
        },
        scales: {
          x: {
            ticks: {
              maxRotation: 0,
              autoSkip: true,
              maxTicksLimit: 8,
              callback: function (value) {
                const iso = this.getLabelForValue(value);
                const d = DateTime.fromISO(iso, { zone: ZONE });
                return [d.toFormat('ccc'), d.toFormat('M/d')];
              }
            }
          }
        }
      }
    });
    const lettersCanvas = document.getElementById('lettersChart');
    lettersChart=new Chart(lettersCanvas,{
      type:'line',
      data:{
        labels,
        datasets:[{ label:'Letters', data: sortedWork.map(r=> +r.letters||0), pointRadius:3, pointHoverRadius:8, pointHitRadius:16 }]
      },
      options: {
        responsive: true,
        interaction: { mode: 'nearest', intersect: false },
        events: ['mousemove','mouseout','click','touchstart','touchmove','touchend'],
        animation: { duration: 0 },
        plugins: {
          legend: { display: false },
          tooltip: {
            animation: { duration: 0 },
            callbacks: {
              title: (items) => {
                const iso = items?.[0]?.label;
                const d = DateTime.fromISO(iso, { zone: ZONE });
                return d.toFormat("cccc ‚Ä¢ MMM d, yyyy");
              }
            }
          }
        },
        scales: {
          x: {
            ticks: {
              maxRotation: 0,
              autoSkip: true,
              maxTicksLimit: 8,
              callback: function (value) {
                const iso = this.getLabelForValue(value);
                const d = DateTime.fromISO(iso, { zone: ZONE });
                return [d.toFormat('ccc'), d.toFormat('M/d')];
              }
            }
          }
        }
      }
    });
    // Improve tap responsiveness on mobile
    enableChartTap(parcelsChart, parcelsCanvas);
    enableChartTap(lettersChart, lettersCanvas);
  }

  function hhmmFrom(baseDateStr, hours){ if(hours==null) return '‚Äî'; const d=DateTime.fromISO(baseDateStr,{zone:ZONE}).set({hour:8,minute:0}); return d.plus({hours}).toFormat('h:mm a'); }

  function buildSnapshot(rows){
    rows = filterRowsForView(rows||[]);
    const today=DateTime.now().setZone(ZONE);
    const dow=today.weekday%7; // 0=Sun
    const workRows=rows.filter(r=>r.status!=='off');

    // Baselines by DOW for expected end
    const byDow=Array.from({length:7},()=>({h:0,c:0}));
    for(const r of workRows){ const h=Number(r.hours||0); if(h>0){ const d=dowIndex(r.work_date); byDow[d].h+=h; byDow[d].c++; } }
    const avgH=byDow.map(x=> x.c? x.h/x.c : null); const todayAvgH=avgH[dow];
    expEnd.textContent = todayAvgH? hhmmFrom(today.toISODate(), todayAvgH) : '‚Äî';
    expMeta.textContent = `${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][dow]} avg ${todayAvgH? todayAvgH.toFixed(2)+'h':'‚Äî'}`;
    // Enable click-to-toggle help on snapshot tiles (once)
    (function enableTileHelp(){
      try{
        const pairs = [
          { id:'badgeVolume', help:'helpVolume' },
          { id:'badgeRouteEff', help:'helpRouteEff' },
          { id:'badgeOverall', help:'helpOverall' },
        ];
        pairs.forEach(p => {
          const badge = document.getElementById(p.id);
          const help = document.getElementById(p.help);
          const tile = badge?.closest('.stat');
          if (!badge || !help || !tile) return;
          if (tile.dataset.helpReady) return; // attach once
          tile.dataset.helpReady = '1';
          tile.style.cursor = 'pointer';
          tile.setAttribute('tabindex','0');
          const toggle = ()=>{ help.style.display = (help.style.display==='none'||!help.style.display)? 'block':'none'; };
          tile.addEventListener('click', (e)=>{
            // ignore clicks on links/buttons inside
            if (e.target.closest('button,a,input,select,textarea')) return;
            toggle();
          });
          tile.addEventListener('keydown', (e)=>{ if (e.key==='Enter'||e.key===' '){ e.preventDefault(); toggle(); } });
        });
      }catch(_){ }
    })();

    // Badges (volume, route eff, overall) using last 30 worked rows
    const lastN = workRows.slice(0,30);
    const volMetric = (r)=> (+r.parcels||0) + 0.33*(+r.letters||0);
    const vols = lastN.map(volMetric);
    const v = vols.length? volMetric(workRows[0]||{}):0;
    const rank = (arr,x)=>{ const s=[...arr].sort((a,b)=>a-b); let i=s.findIndex(n=>x<=n); if(i<0) i=s.length; return i/s.length; };
    const volScore10 = vols.length? Math.round(rank(vols,v)*10) : null;
    if (volScore10==null) badgeVolume.textContent = '‚Äî'; else badgeVolume.textContent = `${volScore10}/10`;
    try{
      if (vols.length){
        const s=[...vols].sort((a,b)=>a-b); const min=s[0], max=s[s.length-1];
        const mid = Math.floor(s.length/2); const med = s.length%2? s[mid] : (s[mid-1]+s[mid])/2;
        const pct = Math.round(rank(vols,v)*100);
        const volTip = `Volume today: ${v.toFixed(1)} (parcels + 0.33√óletters)\nScore: ${volScore10}/10 ‚âà ${pct}th percentile of last ${vols.length} worked days\nNote: This is a rank vs recent days, not % of max.\nRange: min ${min.toFixed(1)} ‚Ä¢ median ${med.toFixed(1)} ‚Ä¢ max ${max.toFixed(1)}`;
        badgeVolume.title = volTip;
        try{ const tile = badgeVolume.closest('.stat'); if (tile) tile.title = volTip; }catch(_){ }
        const hv = document.getElementById('helpVolume');
        if (hv) hv.textContent = `Rank vs recent: ${volScore10}/10 (~${pct}th percentile). Today ${v.toFixed(1)}; min ${min.toFixed(1)}, median ${med.toFixed(1)}, max ${max.toFixed(1)}.`;
      }
    }catch(_){ }
    const rhs = workRows
      .filter(r=> dowIndex(r.work_date)===dow)
      .map(r=> Math.max(0, (+r.route_minutes||0) - boxholderAdjMinutes(r)))
      .filter(n=>n>0);
    const rteAvg = rhs.length? (rhs.reduce((a,b)=>a+b,0)/rhs.length) : null;
    const todayRoute = workRows[0]? Math.max(0, (+workRows[0].route_minutes||0) - boxholderAdjMinutes(workRows[0])) : null;
    const rteScore = (rteAvg && todayRoute!=null && rteAvg>0)? Math.max(0, Math.min(10, Math.round((1 - (todayRoute - rteAvg)/Math.max(1,rteAvg))*10))) : 0;
    badgeRouteEff.textContent = `${rteScore}/10`;
    try{
      const deltaPct = (rteAvg && todayRoute!=null && rteAvg>0)? Math.round(((todayRoute - rteAvg)/rteAvg)*100) : null;
      const adjNote = `adjusted ‚àí${boxholderAdjMinutes(workRows[0])||0}m for boxholders`;
      badgeRouteEff.title = `Route minutes (adjusted): ${todayRoute!=null?Math.round(todayRoute):'‚Äî'} vs weekday avg ${rteAvg!=null?Math.round(rteAvg):'‚Äî'}\nŒî vs avg: ${deltaPct==null?'‚Äî':(deltaPct>=0?('+'+deltaPct):('‚àí'+Math.abs(deltaPct)))}%\nScore: ${rteScore}/10 (higher is better)\nNote: ${adjNote}`;
      const hr = document.getElementById('helpRouteEff');
      if (hr) hr.textContent = `Adjusted route min vs weekday avg. Today ${todayRoute!=null?Math.round(todayRoute):'‚Äî'} vs avg ${rteAvg!=null?Math.round(rteAvg):'‚Äî'}. Score ${rteScore}/10.`;
    }catch(_){ }
    const totToday = workRows[0]? (+workRows[0].hours||0) : 0; const exp = todayAvgH || 0; const overallScore = exp>0? Math.max(0, Math.min(10, Math.round((1 - (totToday - exp)/Math.max(1,exp))*10))) : 0; badgeOverall.textContent = `${overallScore}/10`;
    try{
      const deltaPctTot = exp>0? Math.round(((totToday - exp)/exp)*100) : null;
      badgeOverall.title = `Total hours: ${totToday.toFixed(2)} vs expected ${exp?exp.toFixed(2):'‚Äî'} (weekday avg)\nŒî vs expected: ${deltaPctTot==null?'‚Äî':(deltaPctTot>=0?('+'+deltaPctTot):('‚àí'+Math.abs(deltaPctTot)))}%\nScore: ${overallScore}/10 (higher is better)`;
      const ho = document.getElementById('helpOverall');
      if (ho) ho.textContent = `Total hours vs weekday expected. Today ${totToday.toFixed(2)}h vs exp ${exp?exp.toFixed(2)+'h':'‚Äî'}. Score ${overallScore}/10.`;
    }catch(_){ }

    // ===== Weekly tiles (Monday-based) =====
    const weekStart = startOfWeekMonday(today);
    const weekEnd   = today.endOf('day');
    const prevWeekStart = startOfWeekMonday(today.minus({weeks:1}));
    const prevWeekEnd   = endOfWeekSunday(today.minus({weeks:1}));
    const priorWeekStart = startOfWeekMonday(today.minus({weeks:2}));
    const priorWeekEnd   = endOfWeekSunday(today.minus({weeks:2}));

    const inRange=(r,from,to)=>{ const d=DateTime.fromISO(r.work_date,{zone:ZONE}); return d>=from && d<=to; };
    const sum=(arr,fn)=>arr.reduce((t,x)=>t+(fn(x)||0),0);

    const thisW = workRows.filter(r=> inRange(r,weekStart,weekEnd));
    const lastW = workRows.filter(r=> inRange(r,prevWeekStart,prevWeekEnd));
    const priorW= workRows.filter(r=> inRange(r,priorWeekStart,priorWeekEnd));

    const daysWorked = arr=> arr.filter(r=> (r.hours||0)>0).length;
    const dThis = daysWorked(thisW), dLast = daysWorked(lastW), dPrior = daysWorked(priorW);

    const hThis=sum(thisW,r=>+r.hours||0), pThis=sum(thisW,r=>+r.parcels||0), lThis=sum(thisW,r=>+r.letters||0);
    const hLast=sum(lastW,r=>+r.hours||0), pLast=sum(lastW,r=>+r.parcels||0), lLast=sum(lastW,r=>+r.letters||0);

    // Show live totals as "thisWeek / lastWeek"
    $('wkHours').textContent   = `${(hThis||0).toFixed(2)} / ${(hLast||0).toFixed(2)}`;
    $('wkParcels').textContent = `${pThis||0} / ${pLast||0}`;
    $('wkLetters').textContent = `${lThis||0} / ${lLast||0}`;

    // Carry-forward percentage = last full week's % vs prior week (per-worked-day averages)
    const avgOrNull=(tot,days)=> days? tot/days : null;
    const pct=(a,b)=> (a==null||b==null||b===0)? null : ((a-b)/b)*100;

    const hCarry = pct(avgOrNull(hLast,dLast), avgOrNull(sum(priorW,r=>+r.hours||0), dPrior));
    const pCarry = pct(avgOrNull(pLast,dLast), avgOrNull(sum(priorW,r=>+r.parcels||0), dPrior));
    const lCarry = pct(avgOrNull(lLast,dLast), avgOrNull(sum(priorW,r=>+r.letters||0), dPrior));

    // Current-week target % vs last week (per-worked-day averages so far)
    const hTarget = pct(avgOrNull(hThis,dThis), avgOrNull(hLast,dLast));
    const pTarget = pct(avgOrNull(pThis,dThis), avgOrNull(pLast,dLast));
    const lTarget = pct(avgOrNull(lThis,dThis), avgOrNull(lLast,dLast));

    // Blend from carry-forward toward current as the week progresses (Mon..Fri ‚âà 5 workdays)
    const progress = Math.min(1, dThis/5);
    const blend=(carry,target)=> (carry==null && target==null)? null : (carry==null? target : target==null? carry : carry*(1-progress) + target*progress);

    const dh = blend(hCarry, hTarget);
    const dp = blend(pCarry, pTarget);
    const dl = blend(lCarry, lTarget);

    const fmt = p => {
  if (p == null) return '‚Äî';
  const rounded = Math.round(p);
  return rounded >= 0 ? `‚Üë ${rounded}%` : `‚Üì ${Math.abs(rounded)}%`;
};

// Progressive color scale for deltas (¬±60% window), with simple green/red fallback
function colorForDelta(pct){
  if (pct == null) return { fg:'var(--muted)', bg:'transparent', bc:'var(--border)' };
  // If progressive pills are disabled, use simple green/red
  if (!FLAGS || !FLAGS.progressivePills) {
    return { fg: pct >= 0 ? 'var(--good)' : 'var(--bad)', bg:'transparent', bc:'transparent' };
  }
  const clamp = Math.max(-60, Math.min(60, pct));
  const t = Math.abs(clamp)/60; // 0..1
  // 3-step ramps
  const green = ['#A8E6A3','#4CAF50','#087F23'];
  const red   = ['#F7A6A6','#F44336','#B71C1C'];
  const step = (t<0.17?0 : (t<0.42?1:2));
  const fg = clamp >= 0 ? green[step] : red[step];
  // subtle translucent backgrounds (unused in current UI)
  const bg = 'transparent';
  const bc = 'transparent';
  return { fg, bg, bc };
}

const setPill=(el,delta)=>{
  el.textContent = fmt(delta);
  el.className = 'pill';
  // Minimal style: color only, no background tile/border
  const { fg } = colorForDelta(delta || 0);
  el.style.color = fg || 'var(--text)';
  el.style.background = 'transparent';
  el.style.borderColor = 'transparent';
};
    setPill($('wkHoursDelta'),   dh);
    setPill($('wkParcelsDelta'), dp);
    setPill($('wkLettersDelta'), dl);

    // ===== Advanced Weekly Metrics (Phase 1) =====
    // Day-by-day comparison Mon..today vs same weekday last week,
    // then compute weighted average and cumulative impact (percent).
    const dayIndexToday = (today.weekday + 6) % 7; // Mon=0..Sun=6

    // Build arrays for this week and last week by weekday index (Mon..Sun)
    const toWeekArray = (from, to) => {
      const out = Array.from({ length: 7 }, () => ({ h: 0, p: 0, l: 0 }));
      const inRange = (r) => {
        const d = DateTime.fromISO(r.work_date, { zone: ZONE });
        return d >= from && d <= to;
      };
      workRows.filter(inRange).forEach(r => {
        const d = DateTime.fromISO(r.work_date, { zone: ZONE });
        const idx = (d.weekday + 6) % 7; // Mon=0
        const h = +r.hours || 0;
        const p = +r.parcels || 0;
        const l = +r.letters || 0;
        out[idx].h += h; out[idx].p += p; out[idx].l += l;
      });
      return out;
    };
    const thisWeek = toWeekArray(weekStart, weekEnd);
    const lastWeek = toWeekArray(prevWeekStart, prevWeekEnd);

    // Holiday adjustment detection: if Monday of this week is an explicit off day,
    // treat Tuesday's baseline as (Mon+Tue of last week). Controlled by flag.
    const holidayAdjEnabled = !!(FLAGS && FLAGS.holidayAdjustments);
    // Detect holiday off-days within current week. If found, adjust the NEXT day's baseline
    const carryNext = new Set();
    if (holidayAdjEnabled) {
      try{
        const inWeek = (r)=>{ const d=DateTime.fromISO(r.work_date,{zone:ZONE}); return d>=weekStart && d<=weekEnd; };
        const isHolidayMarked = (r)=> /(^|\b)Holiday(\b|$)/i.test(String(r.weather_json||''));
        rows.filter(r=> r.status==='off' && inWeek(r) && isHolidayMarked(r)).forEach(r=>{
          const d=DateTime.fromISO(r.work_date,{zone:ZONE}); const idx=(d.weekday+6)%7; if (idx<6) carryNext.add(idx+1);
        });
      }catch(_){ /* ignore */ }
    }

    // Off-day detection for current week (so we don't show -100% on off days)
    const offIdxThisWeek = new Set(rows
      .filter(r => r.status === 'off' && inRange(r, weekStart, weekEnd))
      .map(r => (DateTime.fromISO(r.work_date, { zone: ZONE }).weekday + 6) % 7));

    const dailyDeltas = (key) => {
      const arr = [];
      for (let i = 0; i <= dayIndexToday && i < 7; i++) {
        const cur = offIdxThisWeek.has(i) ? null : thisWeek[i][key];
        let base = lastWeek[i][key];
        if (holidayAdjEnabled && carryNext.has(i)) {
          // Baseline for day after a holiday off-day = last week (prev day + this day)
          base = ((lastWeek[i-1]?.[key] || 0) + (lastWeek[i]?.[key] || 0));
        }
        arr.push(cur == null ? null : pct(cur || 0, base || 0));
      }
      return arr; // may include nulls
    };
    const dH = dailyDeltas('h');
    const dP = dailyDeltas('p');
    const dL = dailyDeltas('l');

    const weightedAvg = (arr) => {
      let s = 0, wsum = 0;
      for (let i = 0; i < arr.length; i++) {
        const v = arr[i]; if (v == null || !isFinite(v)) continue;
        const w = i + 1; s += v * w; wsum += w;
      }
      return wsum ? (s / wsum) : null;
    };
    const cumulative = (arr) => {
      let s = 0, seen = false;
      for (const v of arr) { if (v == null || !isFinite(v)) continue; s += v; seen = true; }
      return seen ? s : null;
    };

    const advH = weightedAvg(dH);
    const advP = weightedAvg(dP);
    const advL = weightedAvg(dL);
    const cumH = cumulative(dH);
    const cumP = cumulative(dP);
    const cumL = cumulative(dL);

    // Same-Count Weekly Average: compare N worked days this week vs first N worked days last week
    function sameCountDelta(key){
      const cur = [];
      for (let i = 0; i <= dayIndexToday && i < 7; i++){
        const v = thisWeek[i]?.[key] || 0; if (v>0) cur.push(v);
      }
      const N = cur.length;
      const prior = [];
      for (let i = 0; i < 7; i++){
        const v = lastWeek[i]?.[key] || 0; if (v>0) prior.push(v);
      }
      const M = prior.length;
      if (!N || !M) return { delta:null, n:N, m:M, avgThis:null, avgLast:null };
      const nUse = Math.min(N, M);
      const sumArr = a => a.reduce((t,x)=>t+(+x||0),0);
      const avgThis = sumArr(cur) / N;
      const avgLast = sumArr(prior.slice(0, nUse)) / nUse;
      const delta = pct(avgThis, avgLast);
      return { delta, n:N, m:M, avgThis, avgLast };
    }
    const scH = sameCountDelta('h');
    const scP = sameCountDelta('p');
    const scL = sameCountDelta('l');

    // Display as combined cue: prefer weighted average; fallback to cumulative
    const pick = (sc, w, c) => (sc!=null ? sc : (w != null ? w : c));
    setPill($('advHoursTrend'),   pick(scH.delta, advH, cumH));
    setPill($('advParcelsTrend'), pick(scP.delta, advP, cumP));
    setPill($('advLettersTrend'), pick(scL.delta, advL, cumL));

    // ===== Populate Weekly Hours Details panel =====
    try {
      const panelBody = document.getElementById('wkHoursDetailsBody');
      if (panelBody) {
        // Use precomputed Mon..Sun buckets from Advanced Weekly Metrics
        
        const dNames = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
        const rowsHtml = [];
        let tThis = 0, tLast = 0;
        for (let i = 0; i < 7; i++) {
          const cur = (i <= dayIndexToday) ? (offIdxThisWeek.has(i) ? null : (thisWeek[i]?.h || 0)) : null; // only Mon..today for this week; off-day shows as null
          let base = lastWeek[i]?.h || 0;
          let adjMark = '';
          if (holidayAdjEnabled && carryNext && carryNext.has(i)) { base = (lastWeek[i-1]?.h||0) + (lastWeek[i]?.h||0); adjMark = ' (adj)'; }
          if (cur != null) tThis += cur;
          if (i <= dayIndexToday) tLast += base;
          const delta = (cur == null || base === 0) ? null : ((cur - base) / base) * 100;
          const curTxt = (cur == null) ? 'Off' : cur.toFixed(2);
          const baseTxt = (base === 0) ? 'Off' : base.toFixed(2);
          const { fg } = colorForDelta(delta || 0);
          const deltaTxt = (delta == null) ? '‚Äî' : (delta >= 0 ? `‚Üë ${Math.round(delta)}%` : `‚Üì ${Math.abs(Math.round(delta))}%`);
          rowsHtml.push(`<tr><td>${dNames[i]}${adjMark}</td><td class="right">${curTxt}</td><td class="right">${baseTxt}</td><td class="right" style="color:${fg};white-space:nowrap">${deltaTxt}</td></tr>`);
        }
        const totalDelta = (tLast === 0) ? null : ((tThis - tLast) / tLast) * 100;
        const { fg:totFg } = colorForDelta(totalDelta || 0);
        const totalRow = `<tr><th>Total</th><th class="right">${tThis.toFixed(2)}</th><th class="right">${tLast.toFixed(2)}</th><th class="right" style="color:${totFg}">${totalDelta==null?'‚Äî':(totalDelta>=0?`‚Üë ${Math.round(totalDelta)}%`:`‚Üì ${Math.abs(Math.round(totalDelta))}%`)}</th></tr>`;

        const summaryHtml = `<small><span>This week so far: </span><span style=\"color:var(--warn)\">${tThis.toFixed(2)}h over ${dThis} day(s). Last week: ${tLast.toFixed(2)}h over ${dLast} day(s).</span></small>`;

        panelBody.innerHTML = `
          <div style=\"padding:8px 10px;border-bottom:1px solid var(--border)\">${summaryHtml}</div>
          <table style="width:100%;border-collapse:collapse">
            <thead>
              <tr><th>Day</th><th class="right">This week</th><th class="right">Last week</th><th class="right">Œî%</th></tr>
            </thead>
            <tbody>
              ${rowsHtml.join('')}
            </tbody>
            <tfoot>
              ${totalRow}
            </tfoot>
          </table>
        `;
      }
    } catch (e) {
      console.warn('Failed to populate weekly hours details', e);
    }

    // ===== Populate Weekly Parcels Details panel =====
    try {
      const panelBody = document.getElementById('wkParcelsDetailsBody');
      if (panelBody) {
        const dNames = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
        const rowsHtml = [];
        let tThis = 0, tLast = 0;
        for (let i = 0; i < 7; i++) {
          const cur = (i <= dayIndexToday) ? (offIdxThisWeek.has(i) ? null : (thisWeek[i]?.p || 0)) : null;
          let base = lastWeek[i]?.p || 0;
          let adjMark = '';
          if (holidayAdjEnabled && carryNext && carryNext.has(i)) { base = (lastWeek[i-1]?.p||0) + (lastWeek[i]?.p||0); adjMark=' (adj)'; }
          if (cur != null) tThis += cur;
          if (i <= dayIndexToday) tLast += base;
          const delta = (cur == null || base === 0) ? null : ((cur - base) / base) * 100;
          const curTxt = (cur == null) ? '‚Äî' : String(cur);
          const baseTxt = String(base); // show 0 explicitly
          const { fg } = colorForDelta(delta || 0);
          const deltaTxt = (delta == null) ? '‚Äî' : (delta >= 0 ? `‚Üë ${Math.round(delta)}%` : `‚Üì ${Math.abs(Math.round(delta))}%`);
          rowsHtml.push(`<tr><td>${dNames[i]}${adjMark}</td><td class="right">${curTxt}</td><td class="right">${baseTxt}</td><td class="right" style="color:${fg};white-space:nowrap">${deltaTxt}</td></tr>`);
        }
        const totalDelta = (tLast === 0) ? null : ((tThis - tLast) / tLast) * 100;
        const { fg:totFg } = colorForDelta(totalDelta || 0);
        const totalRow = `<tr><th style=\"color:var(--brand)\">Total (this week vs last)</th><th class=\"right\">${tThis}</th><th class=\"right\">${tLast}</th><th class=\"right\" style=\"color:${totFg}\">${totalDelta==null?'‚Äî':(totalDelta>=0?`‚Üë ${Math.round(totalDelta)}%`:`‚Üì ${Math.abs(Math.round(totalDelta))}%`)}</th></tr>`;
        const summaryHtml = `<small><span>This week so far: </span><span style=\"color:var(--warn)\">${tThis} parcels over ${dThis} day(s). Last week: ${tLast} parcels over ${dLast} day(s).</span></small>`;
        panelBody.innerHTML = `
          <div style=\"padding:8px 10px;border-bottom:1px solid var(--border)\">${summaryHtml}</div>
          <table style=\"width:100%;border-collapse:collapse\">
            <thead><tr><th>Day</th><th class=\"right\">This week</th><th class=\"right\">Last week</th><th class=\"right\">Œî%</th></tr></thead>
            <tbody>${rowsHtml.join('')}</tbody>
            <tfoot>${totalRow}</tfoot>
          </table>`;
      }
    } catch (e) {
      console.warn('Failed to populate weekly parcels details', e);
    }

    // ===== Populate Weekly Letters Details panel =====
    try {
      const panelBody = document.getElementById('wkLettersDetailsBody');
      if (panelBody) {
        const dNames = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
        const rowsHtml = [];
        let tThis = 0, tLast = 0;
        for (let i = 0; i < 7; i++) {
          const cur = (i <= dayIndexToday) ? (offIdxThisWeek.has(i) ? null : (thisWeek[i]?.l || 0)) : null;
          let base = lastWeek[i]?.l || 0;
          let adjMark = '';
          if (holidayAdjEnabled && carryNext && carryNext.has(i)) { base = (lastWeek[i-1]?.l||0) + (lastWeek[i]?.l||0); adjMark=' (adj)'; }
          if (cur != null) tThis += cur;
          if (i <= dayIndexToday) tLast += base;
          const delta = (cur == null || base === 0) ? null : ((cur - base) / base) * 100;
          const curTxt = (cur == null) ? '‚Äî' : String(cur);
          const baseTxt = String(base); // show 0 explicitly
          const { fg } = colorForDelta(delta || 0);
          const deltaTxt = (delta == null) ? '‚Äî' : (delta >= 0 ? `‚Üë ${Math.round(delta)}%` : `‚Üì ${Math.abs(Math.round(delta))}%`);
          rowsHtml.push(`<tr><td>${dNames[i]}${adjMark}</td><td class="right">${curTxt}</td><td class="right">${baseTxt}</td><td class="right" style="color:${fg};white-space:nowrap">${deltaTxt}</td></tr>`);
        }
        const totalDelta = (tLast === 0) ? null : ((tThis - tLast) / tLast) * 100;
        const { fg:totFg } = colorForDelta(totalDelta || 0);
        const totalRow = `<tr><th style=\"color:var(--brand)\">Total (this week vs last)</th><th class=\"right\">${tThis}</th><th class=\"right\">${tLast}</th><th class=\"right\" style=\"color:${totFg}\">${totalDelta==null?'‚Äî':(totalDelta>=0?`‚Üë ${Math.round(totalDelta)}%`:`‚Üì ${Math.abs(Math.round(totalDelta))}%`)}</th></tr>`;
        const summaryHtml = `<small><span>This week so far: </span><span style=\"color:var(--warn)\">${tThis} letters over ${dThis} day(s). Last week: ${tLast} letters over ${dLast} day(s).</span></small>`;
        panelBody.innerHTML = `
          <div style=\"padding:8px 10px;border-bottom:1px solid var(--border)\">${summaryHtml}</div>
          <table style=\"width:100%;border-collapse:collapse\">
            <thead><tr><th>Day</th><th class=\"right\">This week</th><th class=\"right\">Last week</th><th class=\"right\">Œî%</th></tr></thead>
            <tbody>${rowsHtml.join('')}</tbody>
            <tfoot>${totalRow}</tfoot>
          </table>`;
      }
    } catch (e) {
      console.warn('Failed to populate weekly letters details', e);
    }

    // ===== Populate Advanced Weekly Trend panels (H/P/L) =====
    const renderTrendPanel = (bodyId, dailyArr, weightedVal, cumulativeVal, key, sc) => {
      const body = document.getElementById(bodyId);
      if (!body) return;
      const days = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
      const rows = [];
      for (let i = 0; i <= dayIndexToday && i < 7; i++) {
        const v = dailyArr[i];
        const cur = offIdxThisWeek.has(i) ? null : (thisWeek[i]?.[key] || 0);
        let base = lastWeek[i]?.[key] || 0;
        let adjMark = '';
        if (holidayAdjEnabled && carryNext && carryNext.has(i)) { base = (lastWeek[i-1]?.[key]||0) + (lastWeek[i]?.[key]||0); adjMark=' (adj)'; }
        const pctTxt = (v == null || !isFinite(v)) ? '‚Äî' : (v >= 0 ? `‚Üë ${Math.round(v)}%` : `‚Üì ${Math.abs(Math.round(v))}%`);
        const { fg } = colorForDelta(v || 0);
        const fmt = key === 'h' ? (n)=> n.toFixed(2) : (n)=> String(n);
        const curTxt = (i <= dayIndexToday) ? (cur==null ? (key==='h'?'Off':'‚Äî') : fmt(cur)) : '‚Äî';
        const baseTxt = (key === 'h') ? ((base === 0) ? 'Off' : fmt(base)) : fmt(base);
        rows.push(`<tr><td>${days[i]}${adjMark}</td><td class="right">${curTxt}</td><td class="right">${baseTxt}</td><td class="right" style="color:${fg};white-space:nowrap">${pctTxt}</td></tr>`);
      }
      const pickUsed = (sc && sc.delta != null && isFinite(sc.delta)) ? `Weekly Avg (N=${sc.n}${(sc.m&&sc.m!==sc.n)?`, last N=${Math.min(sc.n, sc.m)}`:''})` : ((weightedVal != null && isFinite(weightedVal)) ? 'Weighted' : 'Cumulative');
      const wTxt = (weightedVal == null || !isFinite(weightedVal)) ? '‚Äî' : `${weightedVal>=0?'‚Üë':'‚Üì'} ${Math.abs(Math.round(weightedVal))}%`;
      const cTxt = (cumulativeVal == null || !isFinite(cumulativeVal)) ? '‚Äî' : `${cumulativeVal>=0?'‚Üë':'‚Üì'} ${Math.abs(Math.round(cumulativeVal))}%`;
      const sTxt = (!sc || sc.delta == null || !isFinite(sc.delta)) ? '‚Äî' : `${sc.delta>=0?'‚Üë':'‚Üì'} ${Math.abs(Math.round(sc.delta))}%`;
      const { fg: sFg } = colorForDelta((sc && sc.delta) || 0);
      const { fg: wFg } = colorForDelta(weightedVal || 0);
      const { fg: cFg } = colorForDelta(cumulativeVal || 0);
      body.innerHTML = `
        <table style="width:100%;border-collapse:collapse">
          <thead><tr><th>Day</th><th class=\"right\">This week</th><th class=\"right\">Last week</th><th class=\"right\">Œî%</th></tr></thead>
          <tbody>${rows.join('')}</tbody>
          <tfoot>
            <tr><th colspan=\"3\" class=\"right\">Weekly Avg Œî% ${sc ? `<small class=\\"muted\\">(N=${sc.n}${(sc.m&&sc.m!==sc.n)?`, last N=${Math.min(sc.n, sc.m)}`:''})</small>` : ''}</th><th class=\"right\" style=\"color:${sFg}\">${sTxt}</th></tr>
            <tr><th colspan=\"3\" class=\"right\">Weighted avg Œî%</th><th class=\"right\" style=\"color:${wFg}\">${wTxt}</th></tr>
            <tr><th colspan=\"3\" class=\"right\">Cumulative Œî%</th><th class=\"right\" style=\"color:${cFg}\">${cTxt}</th></tr>
            <tr><th colspan=\"4\" class=\"right\"><small class=\"muted\">Using: ${pickUsed}</small></th></tr>
          </tfoot>
        </table>`;
    };
    try {
      renderTrendPanel('advHoursDetailsBody', dH, advH, cumH, 'h', scH);
      renderTrendPanel('advParcelsDetailsBody', dP, advP, cumP, 'p', scP);
      renderTrendPanel('advLettersDetailsBody', dL, advL, cumL, 'l', scL);
    } catch (e) {
      console.warn('Failed to populate trend panels', e);
    }

    // Today vs same-weekday baseline (worked days only)
    const todayIso = today.toISODate();
    const todaysRow = workRows.find(r => r.work_date === todayIso);
    const sameDow = workRows.filter(r => r.work_date !== todayIso && (dowIndex(r.work_date) === dow));
    // Use last same-weekday (most recent prior) as baseline instead of multi-week average
    const lastSame = sameDow.length ? sameDow[0] : null;
    const baseParcels = lastSame ? (+lastSame.parcels||0) : null;
    const baseLetters = lastSame ? (+lastSame.letters||0) : null;
    const todayParcels = todaysRow? (+todaysRow.parcels||0): null;
    const todayLetters = todaysRow? (+todaysRow.letters||0): null;
    const dayPct=(val,base)=> (val==null || !base)? null : ((val-base)/base)*100;
    const tdp=dayPct(todayParcels, baseParcels), tdl=dayPct(todayLetters, baseLetters);
    const wkNames=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
    document.querySelector('#todayParcelsDelta')?.closest('.stat')?.querySelector('small.muted')?.replaceChildren(document.createTextNode(`vs last ${wkNames[dow]} (worked)`));
    document.querySelector('#todayLettersDelta')?.closest('.stat')?.querySelector('small.muted')?.replaceChildren(document.createTextNode(`vs last ${wkNames[dow]} (worked)`));
    document.querySelector('#todayOfficeDelta')?.closest('.stat')?.querySelector('small.muted')?.replaceChildren(document.createTextNode(`vs last ${wkNames[dow]} (worked)`));
    const baseOffice = lastSame ? (+lastSame.office_minutes||0) : null;
    const todayOffice = todaysRow ? (+todaysRow.office_minutes||0) : null;
    const fmtTiny=p=> p==null? '‚Äî' : (p>=0? `‚Üë ${p.toFixed(0)}%` : `‚Üì ${Math.abs(p).toFixed(0)}%`);
    const tdo=dayPct(todayOffice, baseOffice);
    $('todayParcelsDelta').textContent = fmtTiny(tdp);
    $('todayLettersDelta').textContent = fmtTiny(tdl);
    $('todayOfficeDelta').textContent = fmtTiny(tdo);
    // Minimal color-only styling for today's deltas
    (() => {
      const tp = document.getElementById('todayParcelsDelta');
      const tl = document.getElementById('todayLettersDelta');
      const to = document.getElementById('todayOfficeDelta');
      const { fg:fgP } = colorForDelta(tdp);
      const { fg:fgL } = colorForDelta(tdl);
      const { fg:fgO } = colorForDelta(tdo);
      if (tp) { tp.className='pill'; tp.style.color=fgP; tp.style.background='transparent'; tp.style.borderColor='transparent'; }
      if (tl) { tl.className='pill'; tl.style.color=fgL; tl.style.background='transparent'; tl.style.borderColor='transparent'; }
      if (to) { to.className='pill'; to.style.color=fgO; to.style.background='transparent'; to.style.borderColor='transparent'; }
    })();
}

  try{
    sb.channel('entries-feed').on('postgres_changes',{event:'*',schema:'public',table:'entries'}, async ()=>{
    const rows=await fetchEntries(); allRows=rows; renderTable(applySearch(allRows)); buildCharts(allRows); buildSnapshot(allRows); buildMonthlyGlance(allRows); buildMixViz(allRows); buildSmartSummary(allRows); buildTrendingFactors(allRows); buildOfficeCompare(allRows); buildUspsTiles(allRows);
    }).subscribe();
  }catch(e){ console.warn('Realtime not enabled:', e?.message||e); }

  $('fab').addEventListener('click',()=>{ window.scrollTo({ top:0, behavior:'smooth' }); $('departTime').focus(); });
  $('searchBox').addEventListener('input', ()=>{ renderTable(applySearch(allRows)); });

  (function enableRowNavigation(){
    const tbody=document.querySelector('#tbl tbody'); if(!tbody) return; function activate(e){ const tr=e.target.closest('tr.rowLink'); if(!tr) return; $('date').value=tr.dataset.date; loadByDate(); window.scrollTo({ top:0, behavior:'smooth' }); }
    tbody.addEventListener('click', activate);
    tbody.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ if(e.target.closest('tr.rowLink')){ e.preventDefault(); activate(e); } } });
  })();

  // Collapsed UI scaffolding (experimental): add toggle buttons to collapse sections
  function applyCollapsedUi(){
    const enabled = !!(FLAGS && FLAGS.collapsedUi);
    const targets = [
      { id:'addEntryCard' },
      { id:'dowCard' },
      { id:'parcelsOverTimeCard' },
      { id:'lettersOverTimeCard' },
      { id:'monthlyGlanceCard' },
      { id:'quickFilterCard' },
      { id:'recentEntriesCard' },
    ];
    const storeKey = (id)=> `routeStats.collapse.${id}`;
    const $body = (id)=> document.querySelector('#'+id+' > .__collapseBody');
    const $btn  = (id)=> document.querySelector('#'+id+' .__collapseToggle');

    function setSectionCollapsed(id, collapsed){
      const body = $body(id);
      const btn = $btn(id);
      if (body) body.style.display = collapsed ? 'none' : '';
      if (btn){
        btn.textContent = collapsed ? 'Expand' : 'Collapse';
        btn.setAttribute('aria-expanded', collapsed ? 'false' : 'true');
        const ctrl = btn.getAttribute('aria-controls');
        if (!ctrl && body && body.id) btn.setAttribute('aria-controls', body.id);
      }
      try{ localStorage.setItem(storeKey(id), collapsed ? '1' : '0'); }catch(_){ }
      if (id==='addEntryCard') updateQuickEntryVisibility(collapsed);
    }

    for (const t of targets){
      const sec = document.getElementById(t.id);
      if (!sec) continue;
      // Ensure a header element to host the toggle
      const headerEl = sec.firstElementChild; // usually h3 or header row
      if (!headerEl) continue;
      // Ensure a body wrapper containing all non-header children for reliable show/hide
      let body = sec.querySelector(':scope > .__collapseBody');
      if (!body){
        body = document.createElement('div');
        body.className = '__collapseBody';
        // Move all non-header children into body
        const toMove = [];
        for (let i = 1; i < sec.children.length; i++) toMove.push(sec.children[i]);
        toMove.forEach(node => body.appendChild(node));
        // Assign a unique id for aria-controls linkage
        try{ if (!body.id) body.id = `__cb_${t.id}`; }catch(_){ }
        sec.appendChild(body);
      }
      // Cleanup any stray toggles created previously in the wrong place
      try{
        const toggles = sec.querySelectorAll('.__collapseToggle');
        if (toggles && toggles.length > 1){
          toggles.forEach((b, idx)=>{ if (!headerEl.contains(b) || idx>0) b.remove(); });
        }
      }catch(_){ /* ignore */ }
      // Find or create toggle button (inside header only)
      let btn = headerEl.querySelector('.__collapseToggle');
      if (!btn){
        btn = document.createElement('button');
        btn.className = 'ghost __collapseToggle';
        btn.type = 'button';
        btn.style.marginLeft = 'auto';
        btn.style.float = 'right';
        btn.style.fontSize = '12px';
        btn.textContent = 'Collapse';
        btn.setAttribute('aria-expanded', 'true');
        if (body && body.id) btn.setAttribute('aria-controls', body.id);
        // Append to header (h3 or row)
        try{ headerEl.appendChild(btn); }catch(_){ sec.insertBefore(btn, sec.firstChild); }
      }
      // Handler
      const setCollapsed = (collapsed)=> setSectionCollapsed(t.id, collapsed);
      const saved = (localStorage.getItem(storeKey(t.id)) === '1');
      // Enable/disable per flag
      btn.style.display = enabled ? 'none' : 'none'; // hide explicit button; use header click instead
      if (!enabled){
        // Ensure everything is visible in normal mode
        setCollapsed(false);
        continue;
      }
      // Default: collapse Add Entry and Recent Entries the first time when feature enabled
      if ((t.id==='addEntryCard' || t.id==='recentEntriesCard') && localStorage.getItem(storeKey(t.id)) == null){
        try{ localStorage.setItem(storeKey(t.id), '1'); }catch(_){ }
      }
      const initialCollapsed = (localStorage.getItem(storeKey(t.id)) === '1');
      setCollapsed(initialCollapsed);
      // Header click toggles collapse (ignore clicks on interactive controls inside header)
      const headerToggle = (ev)=>{
        const trg = ev.target;
        if (trg.closest && (trg.closest('#quickEntryBar') || trg.closest('button') || trg.closest('input') || trg.closest('a'))) return;
        const bodyNow = $body(t.id);
        const nowCollapsed = bodyNow && bodyNow.style.display !== 'none' ? true : false;
        setCollapsed(nowCollapsed);
      };
      headerEl.style.cursor = 'pointer';
      headerEl.title = 'Click to expand/collapse';
      headerEl.addEventListener('click', headerToggle);
      headerEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); headerToggle(e); } });
      if (t.id==='addEntryCard') ensureQuickEntryControls(headerEl);
    }
    // removed global Collapse All in favor of Focus Mode
    // expose helpers for Focus Mode
    window.__collapse_targets = targets.map(t=> t.id);
    window.__collapse_set = setSectionCollapsed;
  }

  // Focus Mode: collapse everything except snapshot tiles
  function applyFocusMode(){
    try{
      const btn = document.getElementById('btnFocusMode');
      const enabled = !!(FLAGS && FLAGS.collapsedUi);
      if (!btn) return;
      if (!enabled){ btn.style.display='none'; return; }
      btn.style.display='';
      const on = !!(FLAGS && FLAGS.focusMode);
      btn.textContent = `Focus Mode: ${on?'On':'Off'}`;
      btn.setAttribute('aria-pressed', on ? 'true' : 'false');
      btn.onclick = ()=>{
        FLAGS.focusMode = !FLAGS.focusMode; saveFlags(FLAGS);
        applyFocusMode();
      };
      const targets = window.__collapse_targets || [];
      if (!targets.length) return;
      if (on){
        targets.forEach(id=>{
          if (id==='snapshotCard') return;
          try{ (window.__collapse_set||(()=>{}))(id, true); }catch(_){ }
        });
      } else {
        // Expand everything when Focus Mode turns off
        targets.forEach(id=>{
          try{ (window.__collapse_set||(()=>{}))(id, false); }catch(_){ }
        });
      }
    }catch(_){ /* no-op */ }
  }

  // Quick Entry (experimental): show Hit Street / Return buttons when Add Entry is collapsed
  function ensureQuickEntryControls(headerEl){
    if (!FLAGS.quickEntry) return;
    let bar = document.getElementById('quickEntryBar');
    if (!bar){
      bar = document.createElement('span');
      bar.id = 'quickEntryBar';
      bar.style.cssText = 'float:right; display:none; gap:8px; align-items:center; font-size:12px';
      bar.className = 'row';
      const hitBtn = document.createElement('button'); hitBtn.id='quickHitBtn'; hitBtn.className='ghost btn-compact'; hitBtn.type='button'; hitBtn.textContent='Hit Street (now)';
      const retBtn = document.createElement('button'); retBtn.id='quickReturnBtn'; retBtn.className='ghost btn-compact'; retBtn.type='button'; retBtn.textContent='Return (now)';
      bar.appendChild(hitBtn); bar.appendChild(retBtn);
      try{ headerEl.appendChild(bar); }catch(_){ /* no-op */ }
      hitBtn.onclick = ()=>{ try{ $('departTime').value = hhmmNow(); computeBreakdown(); }catch(_){ } };
      retBtn.onclick = ()=>{ try{ $('returnTime').value = hhmmNow(); computeBreakdown(); }catch(_){ } };
    }
    updateQuickEntryVisibility(localStorage.getItem('routeStats.collapse.addEntryCard') === '1');
  }
  function updateQuickEntryVisibility(isCollapsed){
    const bar = document.getElementById('quickEntryBar');
    if (!bar){ return; }
    const show = !!FLAGS.quickEntry && !!isCollapsed;
    bar.style.display = show ? 'inline-flex' : 'none';
  }

  // Toggle Weekly details panels (hours, parcels, letters)
  (function enableWeeklyPanels(){
    const panels = ['wkHoursDetails','wkParcelsDetails','wkLettersDetails','advHoursDetails','advParcelsDetails','advLettersDetails'];
    function hideOthers(except){ panels.forEach(id => { if(id!==except){ const el=document.getElementById(id); if(el) el.style.display='none'; } }); }
    function enable(tileId, panelId, closeId){
      const tile=document.getElementById(tileId);
      const panel=document.getElementById(panelId);
      const close=document.getElementById(closeId);
      const toggle=()=>{
        if(!panel) return;
        const show = panel.style.display==='none';
        if(show){ hideOthers(panelId); panel.style.display='block'; panel.scrollIntoView({behavior:'smooth', block:'nearest'}); }
        else { panel.style.display='none'; }
      };
      tile?.addEventListener('click', toggle);
      tile?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); toggle(); } });
      close?.addEventListener('click', ()=>{ if(panel) panel.style.display='none'; });
    }
    enable('tileWkHours','wkHoursDetails','closeWkHoursDetails');
    enable('tileWkParcels','wkParcelsDetails','closeWkParcelsDetails');
    enable('tileWkLetters','wkLettersDetails','closeWkLettersDetails');
    enable('tileAdvHours','advHoursDetails','closeAdvHoursDetails');
    enable('tileAdvParcels','advParcelsDetails','closeAdvParcelsDetails');
    enable('tileAdvLetters','advLettersDetails','closeAdvLettersDetails');
  })();

  (async()=>{
    $('date').value=todayStr(); await loadByDate(); const rows=await fetchEntries(); allRows=rows; renderTable(applySearch(allRows)); buildCharts(allRows); buildSnapshot(allRows); buildMonthlyGlance(allRows); buildQuickFilter(allRows); buildMixViz(allRows); buildHeadlineDigest(allRows); buildSmartSummary(allRows); buildTrendingFactors(allRows); buildOfficeCompare(allRows); buildUspsTiles(allRows); computeBreakdown(); applyTrendPillsVisibility(); applyCollapsedUi(); applyFocusMode();
  })();

  console.log('Route Stats loaded ‚Äî', VERSION_TAG);
</script>
<!-- Register the service worker for offline support -->
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('sw.js').catch(function(err) {
        console.error('Service worker registration failed:', err);
      });
    });
  }

  // Monthly Glance (preview): compute last 4 weeks totals and show as text when enabled
  function buildMonthlyGlance(rows){
    rows = filterRowsForView(rows||[]);
    const card = document.getElementById('monthlyGlanceCard');
    if (!card) return;
    // Always render Monthly Glance card; flag only controls charts below
    card.style.display='block';
    const today = DateTime.now().setZone(ZONE);
    const weekStart0 = startOfWeekMonday(today);
    const weekEnd0   = today.endOf('day');
    const weekStart1 = startOfWeekMonday(today.minus({weeks:1}));
    const weekEnd1   = endOfWeekSunday(today.minus({weeks:1}));
    const weekStart2 = startOfWeekMonday(today.minus({weeks:2}));
    const weekEnd2   = endOfWeekSunday(today.minus({weeks:2}));
    const weekStart3 = startOfWeekMonday(today.minus({weeks:3}));
    const weekEnd3   = endOfWeekSunday(today.minus({weeks:3}));

    const inRange=(r,from,to)=>{ const d=DateTime.fromISO(r.work_date,{zone:ZONE}); return d>=from && d<=to; };
    const worked = rows.filter(r=> r.status!=='off');

    function totals(from,to){
      const arr = worked.filter(r=> inRange(r,from,to));
      const h = arr.reduce((t,r)=> t + (+r.hours||0), 0);
      const p = arr.reduce((t,r)=> t + (+r.parcels||0), 0);
      const l = arr.reduce((t,r)=> t + (+r.letters||0), 0);
      return {h,p,l};
    }
    const W3 = totals(weekStart3, weekEnd3);
    const W2 = totals(weekStart2, weekEnd2);
    const W1 = totals(weekStart1, weekEnd1);
    const W0 = totals(weekStart0, weekEnd0);

    const fmtH = n => (n||0).toFixed(1);
    const labels = [weekEnd3, weekEnd2, weekEnd1, weekEnd0].map(d=> d.toFormat('LLL dd'));

    // Always set text fallback first
    const hoursDiv   = document.getElementById('mgHours');
    const parcelsDiv = document.getElementById('mgParcels');
    const lettersDiv = document.getElementById('mgLetters');
    // Label most recent as W1 (no week zero), older as W2..W4
    hoursDiv.textContent   = `W4 ${fmtH(W3.h)} ‚Ä¢ W3 ${fmtH(W2.h)} ‚Ä¢ W2 ${fmtH(W1.h)} ‚Ä¢ W1 ${fmtH(W0.h)}`;
    parcelsDiv.textContent = `W4 ${W3.p} ‚Ä¢ W3 ${W2.p} ‚Ä¢ W2 ${W1.p} ‚Ä¢ W1 ${W0.p}`;
    lettersDiv.textContent = `W4 ${W3.l} ‚Ä¢ W3 ${W2.l} ‚Ä¢ W2 ${W1.l} ‚Ä¢ W1 ${W0.l}`;

    // Render sparklines if Chart.js is present
    if (window.Chart){
      try{
        function renderSpark(target, dataArr, color, metricName, starts, ends){
          // Clear target and rebuild with a tiny Avg pill above the canvas
          target.innerHTML = '';
          // Compute simple average of the 4 week values
          const nums = (dataArr||[]).filter(v=> v!=null && isFinite(v));
          const avg = nums.length ? nums.reduce((a,b)=>a+Number(b),0)/nums.length : null;
          const fmtAvg = (v)=>{
            if (v==null) return '‚Äî';
            return metricName === 'Hours' ? (Math.round(v*10)/10).toFixed(1)+'h' : String(Math.round(v));
          };
          // Chart wrapper (full width)
          const wrap = document.createElement('div');
          wrap.style.display = 'flex';
          wrap.style.flexDirection = 'column';
          wrap.style.width = '100%';
          // Avg pill (small, above chart, does not steal width)
          const avgEl = document.createElement('span');
          avgEl.className = 'pill';
          avgEl.style.fontSize = '11px';
          avgEl.style.padding = '2px 6px';
          avgEl.style.alignSelf = 'flex-start';
          avgEl.style.marginBottom = '4px';
          avgEl.innerHTML = `<small>Avg</small> <b>${fmtAvg(avg)}</b>`;
          wrap.appendChild(avgEl);
          // Create canvas + labels
          const canvas = document.createElement('canvas');
          canvas.className = 'sparkline';
          try{ canvas.height = 56; }catch(_){}
          canvas.style.height = '56px';
          canvas.style.maxHeight = '56px';
          canvas.style.width = '100%';
          canvas.style.cursor = 'pointer';
          wrap.appendChild(canvas);
          const lbl = document.createElement('div');
          lbl.className = 'sparkline-labels';
          lbl.textContent = labels.join(' ‚Ä¢ ');
          wrap.appendChild(lbl);
          const summary = document.createElement('div');
          summary.className = 'sparkline-summary';
          summary.textContent = 'Click a dot for details';
          wrap.appendChild(summary);
          target.appendChild(wrap);

          const ctx = canvas.getContext('2d');
          // Create a minimal line chart with points only + subtle line
          const chart = new Chart(ctx, {
            type: 'line',
            data: {
              labels,
              datasets: [{
                label: metricName,
                data: dataArr,
                borderColor: color,
                backgroundColor: color,
                tension: 0.25,
                fill: false,
                borderWidth: 1,
                pointRadius: 3,
                pointHoverRadius: 6,
                pointHitRadius: 14,
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              layout: {
                // Extra breathing room so end dots/labels do not clip
                padding: { top: 14, right: 24, bottom: 12, left: 24 }
              },
              interaction: { mode: 'nearest', intersect: false },
              scales: {
                x: { display: false },
                y: { display: false }
              },
              plugins: {
                legend: { display: false },
                tooltip: {
                  enabled: true,
                  callbacks: {
                    title: (items)=> {
                      try{ return fmtRange(items[0].dataIndex); }catch(_){ return ''; }
                    },
                    label: (item)=> {
                      const v = item.parsed.y;
                      if (metricName === 'Hours') return `Hours: ${(+v).toFixed(1)}h`;
                      return `${metricName}: ${Math.round(+v)}`;
                    }
                  }
                }
              },
              elements: {
                point: { pointStyle: 'circle' }
              }
            },
            plugins: []
          });

          function fmtVal(v){
            if (v == null) return '‚Äî';
            if (metricName === 'Hours') return (Math.round(v*10)/10).toFixed(1) + 'h';
            return String(Math.round(v));
          }
          function fmtRange(i){
            try{
              const s = starts[i];
              const e = ends[i];
              if (s && e && s.toFormat && e.toFormat){
                return s.toFormat('LLL dd') + ' ‚Äì ' + e.toFormat('LLL dd');
              }
            }catch(_){ }
            return labels[i] || '';
          }

          // Click: nearest point ‚Üí show mini summary
          canvas.addEventListener('click', (evt)=>{
            try{
              const points = chart.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, false);
              if (!points || !points.length) return;
              const idx = points[0].index;
              const msg = `${metricName}: ${fmtVal(dataArr[idx])} ¬∑ ${fmtRange(idx)}`;
              summary.textContent = msg;
            }catch(_){ /* ignore */ }
          });
          // Keyboard: Enter/Space cycles through points
          canvas.tabIndex = 0;
          canvas.addEventListener('keydown', (e)=>{
            if (e.key !== 'Enter' && e.key !== ' ') return;
            e.preventDefault();
            const cur = (labels.indexOf((summary.textContent||'').split('¬∑').pop()?.trim()) + 1) % dataArr.length;
            const msg = `${metricName}: ${fmtVal(dataArr[cur])} ¬∑ ${fmtRange(cur)}`;
            summary.textContent = msg;
          });
        }
        const starts = [weekStart3, weekStart2, weekStart1, weekStart0];
        const ends   = [weekEnd3,   weekEnd2,   weekEnd1,   weekEnd0];
        renderSpark(hoursDiv,   [W3.h, W2.h, W1.h, W0.h].map(n=> +(n||0).toFixed(1)), getComputedStyle(document.documentElement).getPropertyValue('--good').trim()  || '#7CE38B', 'Hours',   starts, ends);
        renderSpark(parcelsDiv, [W3.p, W2.p, W1.p, W0.p],                        getComputedStyle(document.documentElement).getPropertyValue('--brand').trim() || '#2b7fff', 'Parcels', starts, ends);
        renderSpark(lettersDiv, [W3.l, W2.l, W1.l, W0.l],                        getComputedStyle(document.documentElement).getPropertyValue('--warn').trim()  || '#FFD27A', 'Letters', starts, ends);
      }catch(e){
        console.warn('Monthly Glance charts failed; showing text fallback', e);
      }
    }
    // If Chart.js missing, try to dynamically load the local vendor copy once
    else if (!window.__chartLoadAttempted){
      window.__chartLoadAttempted = true;
      try{
        const script = document.createElement('script');
        script.src = 'vendor/chart.umd.js';
        script.async = true;
        script.onload = ()=>{
          try{
            if (window.Chart){
              // Rebuild all charted views now that Chart.js is available
              try{ buildMonthlyGlance(allRows||rows||[]); }catch(_){}
              try{ buildCharts(allRows||rows||[]); }catch(_){}
              try{ buildMixViz(allRows||rows||[]); }catch(_){}
              try{ buildOfficeCompare(allRows||rows||[]); }catch(_){}
              try{ buildQuickFilter(allRows||rows||[]); }catch(_){}
            }
          }catch(_){ /* ignore */ }
        };
        script.onerror = ()=> console.warn('Failed to load vendor/chart.umd.js; keeping text fallback');
        document.head.appendChild(script);
      }catch(e){ console.warn('Error injecting Chart.js script', e); }
    }
  }

  // Headline digest (Wed evening only): soft summary under title
  function buildHeadlineDigest(rows){
    rows = filterRowsForView(rows||[]);
    try{
      const el = document.getElementById('headlineDigest'); if(!el) return;
      const now = DateTime.now().setZone(ZONE);
      const isWed = (now.weekday === 3); // Mon=1..Sun=7
      const isEvening = now.hour >= 17; // 5pm local
      const show = !!FLAGS.headlineDigest && isWed && isEvening;
      if (!show){ el.style.display='none'; return; }

      // Blended % for Hours (carry-forward toward today's per-day avg)
      const startOfWeek = startOfWeekMonday(now);
      const endToday    = now.endOf('day');
      const prevStart   = startOfWeekMonday(now.minus({weeks:1}));
      const prevEnd     = endOfWeekSunday(now.minus({weeks:1}));
      const priorStart  = startOfWeekMonday(now.minus({weeks:2}));
      const priorEnd    = endOfWeekSunday(now.minus({weeks:2}));
      const inRange=(r,from,to)=>{ const d=DateTime.fromISO(r.work_date,{zone:ZONE}); return d>=from && d<=to; };
      const worked = rows.filter(r=> r.status!=='off');
      const thisW = worked.filter(r=> inRange(r,startOfWeek,endToday));
      const lastW = worked.filter(r=> inRange(r,prevStart,prevEnd));
      const priorW= worked.filter(r=> inRange(r,priorStart,priorEnd));
      const daysWorked = arr=> arr.filter(r=> (+r.hours||0)>0).length;
      const dThis=daysWorked(thisW), dLast=daysWorked(lastW), dPrior=daysWorked(priorW);
      const sumH = (arr)=> arr.reduce((t,r)=> t + (+r.hours||0), 0);
      const avgOrNull=(tot,days)=> days? tot/days : null;
      const pct=(a,b)=> (a==null||b==null||b===0)? null : ((a-b)/b)*100;
      const hCarry = pct(avgOrNull(sumH(lastW),dLast), avgOrNull(sumH(priorW),dPrior));
      const hTarget= pct(avgOrNull(sumH(thisW),dThis), avgOrNull(sumH(lastW),dLast));
      const progress=Math.min(1, dThis/5);
      const blended = (hCarry==null && hTarget==null)? null : (hCarry==null? hTarget : hTarget==null? hCarry : (hCarry*(1-progress) + hTarget*progress));
      const val = blended==null? 0 : Math.round(blended);
      let msg;
      if (val <= -15) msg = 'Much lighter than last week.';
      else if (val < -5) msg = 'A bit lighter than last week.';
      else if (val <= 5) msg = 'Similar to last week ‚Äî average days.';
      else if (val < 15) msg = 'A bit heavier than last week.';
      else msg = 'Much more intense than last week. Deep breath.';
      el.textContent = msg;
      el.style.display='block';
    }catch(_){ /* no-op */ }
  }

  // Volume Mix: normalized side-by-side bars (Parcels vs Letters√ó0.33)
  function buildMixViz(rows){
    rows = filterRowsForView(rows||[]);
    const card = document.getElementById('mixVizCard'); if(!card) return;
    if (!FLAGS.mixViz) { card.style.display='none'; return; }
    // Show card early so header is visible even if later logic fails
    card.style.display='block';
    const text = document.getElementById('mixText');
    const eff  = document.getElementById('mixEff');
    const overlay = document.getElementById('weekOverlay');
    const details = document.getElementById('mixCompareDetails');
    const btn = document.getElementById('mixCompareBtn');
    const now = DateTime.now().setZone(ZONE);
    const startThis = startOfWeekMonday(now);
    const endThis   = now.endOf('day');
    const startLast = startOfWeekMonday(now.minus({weeks:1}));
    const lastEndSame = startOfWeekMonday(now.minus({weeks:1})).plus({days: now.weekday-1}).endOf('day');
    const endLastFull = endOfWeekSunday(now.minus({weeks:1}));
    const inRange=(r,from,to)=>{ const d=DateTime.fromISO(r.work_date,{zone:ZONE}); return d>=from && d<=to; };
    const worked = rows.filter(r=> r.status!=='off');
    const W0 = worked.filter(r=> inRange(r,startThis,endThis));
    const W1 = worked.filter(r=> inRange(r,startLast,lastEndSame));
    const sum = (arr,fn)=> arr.reduce((t,x)=> t + (fn(x)||0), 0);
    const p0=sum(W0,r=>+r.parcels||0), p1=sum(W1,r=>+r.parcels||0);
    const l0=sum(W0,r=>+r.letters||0), l1=sum(W1,r=>+r.letters||0);
    const ln0 = +(0.33*l0).toFixed(1);
    const ln1 = +(0.33*l1).toFixed(1);
    try{
      // Labeling: W1 = current (Mon..today), W2 = last (same range)
      if (text) text.textContent = `W1: Parcels ${p0}, Letters ${l0} ‚Ä¢ W2: Parcels ${p1}, Letters ${l1}`;
    const vol0 = p0 + 0.33*l0; const vol1 = p1 + 0.33*l1;
    const rm0  = sum(W0,r=> Math.max(0, (+r.route_minutes||0) - boxholderAdjMinutes(r)));
    const rm1  = sum(W1,r=> Math.max(0, (+r.route_minutes||0) - boxholderAdjMinutes(r)));
    const idx0 = (vol0>0 && rm0>0) ? (rm0/vol0) : null;
    const idx1 = (vol1>0 && rm1>0) ? (rm1/vol1) : null;
    let deltaStr = '‚Äî', deltaStyle='';
    if (idx0!=null && idx1!=null && idx1>0){
      const imp = ((idx1 - idx0) / idx1) * 100;
      const s = Math.round(imp);
      const fg = (imp >= 0) ? 'var(--good)' : 'var(--bad)';
      deltaStr = `${s>=0?'‚Üë':'‚Üì'} ${Math.abs(s)}%`;
      deltaStyle = `color:${fg}`;
    }
    if (eff){
      const a = idx0==null? '‚Äî' : (Math.round(idx0*100)/100).toFixed(2);
      const b = idx1==null? '‚Äî' : (Math.round(idx1*100)/100).toFixed(2);
      eff.innerHTML = `Efficiency index (min/vol): ${a} vs ${b} <span style="${deltaStyle}">${deltaStr}</span>`;
    }
    const d = (a,b)=> (b>0)? Math.round(((a-b)/b)*100) : null;
    const dH = d(sum(W0,r=>+r.hours||0), sum(W1,r=>+r.hours||0));
    let dP, dLx, lineLabelP='Parcels', lineLabelL='Letters';
    // Ensure scoped defaults so details rendering doesn't break when baselineCompare is off
    let resP = { used: 0 };
    let resL = { used: 0 };
    const baselines = ensureWeeklyBaselines(rows) || getWeeklyBaselines();
    const anchor = computeAnchorBaselines(rows, 8);
    if (FLAGS.baselineCompare){
      // Baseline-normalized: compare this week's Mon..today vs weekday baselines from previous 2 weeks
      const dayIdxToday = (now.weekday + 6) % 7; // Mon=0..Sun=6
      const mins = 5; // guardrail: require baseline >= 5 units per weekday
      // Helpers
      const sumRange = (arr, upto)=>{ let s=0; for(let i=0;i<=upto;i++){ const v=arr[i]; s+= (v!=null? v:0); } return s; };
      const byW = (arr,fn)=>{
        const out = Array.from({length:7},()=>0);
        arr.forEach(r=>{ const d=DateTime.fromISO(r.work_date,{zone:ZONE}); const idx=(d.weekday+6)%7; out[idx] += (fn(r)||0); });
        return out;
      };
      const alignedDelta = (curArr, baseArr, upto, min)=>{
        let curSum=0, baseSum=0, used=0;
        for (let i=0;i<=upto;i++){
          const base = baseArr ? baseArr[i] : null;
          if (base!=null && base>=min){
            curSum += (curArr[i]||0);
            baseSum += base;
            used++;
          }
        }
        if (!used || baseSum<=0) return { delta:null, used:0 };
        let d = Math.round(((curSum - baseSum)/baseSum)*100);
        if (d>100) d=100; if (d<-100) d=-100;
        return { delta:d, used };
      };
      const pThisW = byW(W0, r=> +r.parcels||0);
      const lThisW = byW(W0, r=> +r.letters||0);
      const bp = baselines ? baselines.parcels : null;
      const bl = baselines ? baselines.letters : null;
      resP = alignedDelta(pThisW, bp, dayIdxToday, mins);
      resL = alignedDelta(lThisW, bl, dayIdxToday, mins);
      dP = resP.delta;
      dLx= resL.delta;
      lineLabelP = 'Parcels (vs baseline)';
      lineLabelL = 'Letters (vs baseline)';
      // Anchor drift (optional, show as part of details header)
      let driftLine = '';
      if (anchor && anchor.parcels && anchor.letters){
        const ap = sumRange(anchor.parcels, dayIdxToday);
        const al = sumRange(anchor.letters, dayIdxToday);
        // aligned baseline sums over weekdays we have baselines for
        const sumAligned=(arr,upto,min)=>{ let s=0; let used=0; for(let i=0;i<=upto;i++){ const v=arr?arr[i]:null; if (v!=null && v>=min){ s+=v; used++; } } return used? s: null; };
        const bpAligned = sumAligned(bp, dayIdxToday, mins);
        const blAligned = sumAligned(bl, dayIdxToday, mins);
        const driftP = (ap>0 && bpAligned!=null)? Math.round(((bpAligned - ap)/ap)*100) : null;
        const driftL = (al>0 && blAligned!=null)? Math.round(((blAligned - al)/al)*100) : null;
        driftLine = `Baseline drift vs anchor ‚Äî Parcels: ${driftP==null?'‚Äî':(driftP>=0?('‚Üë '+driftP+'%'):('‚Üì '+Math.abs(driftP)+'%'))} ‚Ä¢ Letters: ${driftL==null?'‚Äî':(driftL>=0?('‚Üë '+driftL+'%'):('‚Üì '+Math.abs(driftL)+'%'))}`;
        // Prepend drift line on first render
        if (details && !details._driftInjected){
          const div=document.createElement('div'); div.className='sparkline-labels'; div.textContent=driftLine; details.parentNode.insertBefore(div, details);
          details._driftInjected = true;
        }
      }
    } else {
      // Simple week-over-week (Mon..today vs last Mon..today)
      dP = d(p0,p1);
      dLx= d(l0,l1);
    }
    const dEff = ( (p0+ln0)>0 && (p1+ln1)>0 )
      ? Math.round((( (rm1/(p1+ln1)) - (rm0/(p0+ln0)) ) / (rm1/(p1+ln1)) )*100)
      : null;
    const arrow=(v)=> v==null?'‚Äî':(v>=0?'‚Üë '+v+'%':'‚Üì '+Math.abs(v)+'%');
    const color=(v)=> v==null?'var(--text)':(v>=0?'var(--good)':'var(--bad)');
    const line=(label,v,ctx)=> `<div>${label}: <span style="color:${color(v)}">${arrow(v)}</span> ${ctx||''}</div>`;
    if (details){
      const usedP = (typeof resP!== 'undefined' && resP && resP.used) ? `, ${resP.used} day(s) used` : '';
      const usedL = (typeof resL!== 'undefined' && resL && resL.used) ? `, ${resL.used} day(s) used` : '';
      details.innerHTML = [
        line('Efficiency', dEff, `(min/vol ${ ( (rm0/(p0+ln0))||0 ).toFixed(2) } vs ${ ( (rm1/(p1+ln1))||0 ).toFixed(2) })`),
        line(lineLabelP, dP, `(${p0} vs ${p1}${usedP})`),
        line(lineLabelL, dLx, `(${l0} vs ${l1}${usedL})`),
        line('Hours', dH, `(${(sum(W0,r=>+r.hours||0)).toFixed(1)}h vs ${(sum(W1,r=>+r.hours||0)).toFixed(1)}h)`)
      ].join('');
    }
    } catch (e) {
      console.error('[MixViz] render error', e);
      if (details) details.innerHTML = '<div>Compare unavailable ‚Äî data not ready.</div>';
    }
    // Week overlay sparkline (this Mon..today vs last Mon..Sun)
    try{
      if (overlay && window.Chart && overlay.getContext){
        const ctx = overlay.getContext('2d');
        if (overlay._chart) { try{ overlay._chart.destroy(); }catch(_){ } }
        const days = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
        const brand = getComputedStyle(document.documentElement).getPropertyValue('--brand').trim()||'#2b7fff';
        const warn  = getComputedStyle(document.documentElement).getPropertyValue('--warn').trim() || '#FFD27A';
        // Build daily volume arrays
        const volByDow = (arr)=>{
          const a = Array.from({length:7},()=>0);
          arr.forEach(r=>{ const d=DateTime.fromISO(r.work_date,{zone:ZONE}); const idx=(d.weekday+6)%7; a[idx]+= (+r.parcels||0) + 0.33*(+r.letters||0); });
          return a.map(n=> +(Math.round(n*10)/10).toFixed(1));
        };
        const thisBy = volByDow(W0);
        // Baseline uses LAST FULL WEEK (Mon..Sun) so the blue line is complete
        const W1full = worked.filter(r=> inRange(r, startLast, endLastFull));
        const lastBy = volByDow(W1full);
        const dayIdxToday = (now.weekday + 6) % 7;
        const thisMasked = thisBy.map((v,i)=> i<=dayIdxToday? v : null);
        overlay._chart = new Chart(ctx, {
          type:'line',
          data:{ labels:days, datasets:[
            { label:'Last week', data:lastBy, borderColor:brand, backgroundColor:'transparent', tension:0.25, pointRadius:3, pointHoverRadius:6, pointHitRadius:14, borderWidth:2, spanGaps:true },
            { label:'This week', data:thisMasked, borderColor:warn,  backgroundColor:'transparent', tension:0.25, pointRadius:3, pointHoverRadius:6, pointHitRadius:14, borderWidth:2, spanGaps:true }
          ]},
          options:{ responsive:true, maintainAspectRatio:false,
            layout:{ padding:{ top:12, right:16, bottom:10, left:16 } },
            interaction:{ mode:'nearest', intersect:false },
            plugins:{ legend:{ display:false }, tooltip:{
              callbacks:{
                title:(items)=> items && items[0]? items[0].label : '',
                label:(item)=>{
                  const i=item.dataIndex; const lw=lastBy[i]; const tw=thisBy[i];
                  const hasTw = i<=dayIdxToday && tw!=null;
                  return hasTw? `This: ${tw} (Last: ${lw})` : `Last: ${lw}`;
                }
              }
            }},
            scales:{ x:{ display:true, grid:{ display:false } }, y:{ display:false } }
          }
        });
      }
    }catch(_){ /* no-op */ }
    // Baseline drift sparkline (last 8 full weeks, Mon..Sun totals)
    try{
      const driftCanvas = document.getElementById('mixDrift');
      const driftText = document.getElementById('mixDriftText');
      if (driftCanvas && driftText){
        const weeksBack = 5; // use last 5 completed weeks
        const weeksArr=[]; for(let w=weeksBack; w>=1; w--){ const s=startOfWeekMonday(now.minus({weeks:w})); const e=endOfWeekSunday(now.minus({weeks:w})); weeksArr.push({s,e}); }
        const weekSum=(wk,fn)=> worked.filter(r=>{ const d=DateTime.fromISO(r.work_date,{zone:ZONE}); return d>=wk.s && d<=wk.e; }).reduce((t,r)=> t+(fn(r)||0),0);
        const combSer = weeksArr.map(wk=>{
          const p=weekSum(wk, r=>+r.parcels||0); const l=weekSum(wk, r=>+r.letters||0); return +(p + 0.33*l).toFixed(1);
        }).filter(v=> v>0);
        // Drift labels: W1 = most recent completed week, W{n} older
        const labels = weeksArr.slice(-combSer.length).map((wk,i)=> `W${combSer.length-i}`);
        // Anchor = median of combined series (non-zero)
        const sorted=[...combSer].sort((a,b)=>a-b); const n=sorted.length; const anchorVal = n? (n%2? sorted[Math.floor(n/2)] : (sorted[n/2-1]+sorted[n/2])/2) : 0;
        driftText.textContent = `Combined vol (P + 0.33√óL): ${combSer.join(', ')} ‚Ä¢ Anchor: ${anchorVal}`;
        if (window.Chart && driftCanvas.getContext){
          const ctx = driftCanvas.getContext('2d');
          if (driftCanvas._chart) { try{ driftCanvas._chart.destroy(); }catch(_){} }
          const brand = getComputedStyle(document.documentElement).getPropertyValue('--brand').trim()||'#2b7fff';
          const warn  = getComputedStyle(document.documentElement).getPropertyValue('--warn').trim() || '#FFD27A';
          driftCanvas._chart = new Chart(ctx, {
            type:'line',
            data:{ labels, datasets:[
              { label:'Combined', data:combSer, borderColor:warn, backgroundColor:'transparent', tension:0.25, pointRadius:2, borderWidth:1 },
              { label:'Anchor', type:'line', data:combSer.map(()=>anchorVal), borderColor:brand, backgroundColor:'transparent', borderDash:[4,2], pointRadius:0, tension:0 }
            ]},
            options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false }, tooltip:{ enabled:false } }, scales:{ x:{ display:false }, y:{ display:false } } }
          });
        }
      }
    }catch(_){ /* ignore */ }

    // (Historical baseline comparison removed per scope)
    btn?.addEventListener('click', ()=>{
      if (!details) return;
      const show = details.style.display==='none';
      details.style.display = show ? 'block' : 'none';
    });
    // Already shown early; keep behavior consistent
  }

  // Smart Summary (rule-based, text-only): concise 1‚Äì2 lines under the title
  function buildSmartSummary(rows){
    rows = filterRowsForView(rows||[]);
    try{
      const el = document.getElementById('smartSummary'); if (!el) return;
      if (!FLAGS.smartSummary) { el.style.display='none'; return; }
      const now = DateTime.now().setZone(ZONE);
      const startThis = startOfWeekMonday(now);
      const endThis   = now.endOf('day');
      const startLast = startOfWeekMonday(now.minus({weeks:1}));
      const lastEndSame = startOfWeekMonday(now.minus({weeks:1})).plus({days: now.weekday-1}).endOf('day');
      const inRange=(r,from,to)=>{ const d=DateTime.fromISO(r.work_date,{zone:ZONE}); return d>=from && d<=to; };
      const worked = (rows||[]).filter(r=> r.status!=='off');
      const W0 = worked.filter(r=> inRange(r,startThis,endThis));
      const W1 = worked.filter(r=> inRange(r,startLast,lastEndSame));
      const sum = (arr,fn)=> arr.reduce((t,x)=> t + (fn(x)||0), 0);
      const h0 = sum(W0, r=> +r.hours||0), h1 = sum(W1, r=> +r.hours||0);
      const p0 = sum(W0, r=> +r.parcels||0), p1 = sum(W1, r=> +r.parcels||0);
      const l0 = sum(W0, r=> +r.letters||0), l1 = sum(W1, r=> +r.letters||0);
      const vol = (p,l)=> p + 0.33*l;
      const v0 = vol(p0,l0), v1 = vol(p1,l1);
    const rm0 = sum(W0, r=> Math.max(0, (+r.route_minutes||0) - boxholderAdjMinutes(r))),
          rm1 = sum(W1, r=> Math.max(0, (+r.route_minutes||0) - boxholderAdjMinutes(r)));
      const idx = (rm, vv)=> (rm>0 && vv>0) ? (rm/vv) : null; // minutes per combined volume
      const i0 = idx(rm0, v0), i1 = idx(rm1, v1);
      const pct = (a,b)=> (b>0) ? Math.round(((a-b)/b)*100) : null; // nearest 1%
      const dh = pct(h0, h1);
      const dv = pct(v0, v1);
      const di = (i0!=null && i1!=null && i1>0) ? Math.round(((i1 - i0)/i1)*100) : null; // improvement positive
      const items = [];
      if (dh!=null && Math.abs(dh) >= 5) items.push({ k:'Hours', v:dh });
      if (dv!=null && Math.abs(dv) >= 5) items.push({ k:'Volume', v:dv });
      if (di!=null && Math.abs(di) >= 5) items.push({ k:'Efficiency', v:di });
      // sort by absolute magnitude, descending, and pick top 2 movers
      items.sort((a,b)=> Math.abs(b.v) - Math.abs(a.v));
      const top = items.slice(0,2);
      const parts = top.map(it => `${it.k} ${it.v>=0?`‚Üë ${it.v}%`:`‚Üì ${Math.abs(it.v)}%`}`);
      const days = [...new Set(W0.map(r=> r.work_date))].length;
      const line = parts.length ? parts.join(' ‚Ä¢ ') : 'Similar to last week';
      el.textContent = `${line} ‚Äî ${days} day(s) this week.`;
      el.style.display='block';
    }catch(_){ /* no-op */ }
  }

  // Trending Factors: top two movers this week vs last (Mon..today vs Mon..today).
  function buildTrendingFactors(rows){
    rows = filterRowsForView(rows||[]);
    try{
      const el = document.getElementById('trendFactors'); if(!el) return;
      const now = DateTime.now().setZone(ZONE);
      const startThis = startOfWeekMonday(now);
      const endThis   = now.endOf('day');
      const startLast = startOfWeekMonday(now.minus({weeks:1}));
      const lastEndSame = startOfWeekMonday(now.minus({weeks:1})).plus({days: now.weekday-1}).endOf('day');
      const inRange=(r,from,to)=>{ const d=DateTime.fromISO(r.work_date,{zone:ZONE}); return d>=from && d<=to; };
      const worked = (rows||[]).filter(r=> r.status!=='off');
      const W0 = worked.filter(r=> inRange(r,startThis,endThis));
      const W1 = worked.filter(r=> inRange(r,startLast,lastEndSame));
      const sum = (arr,fn)=> arr.reduce((t,x)=> t + (fn(x)||0), 0);
      const off0 = sum(W0, r=> +r.office_minutes||0), off1 = sum(W1, r=> +r.office_minutes||0);
      const rm0  = sum(W0, r=> Math.max(0, (+r.route_minutes||0) - boxholderAdjMinutes(r)));
      const rm1  = sum(W1, r=> Math.max(0, (+r.route_minutes||0) - boxholderAdjMinutes(r)));
      const vol = (arr)=> sum(arr, r=> (+r.parcels||0) + 0.33*(+r.letters||0));
      const v0 = vol(W0), v1 = vol(W1);
      const pct = (a,b)=> (b>0)? Math.round(((a-b)/b)*100) : null;
      const items = [];
      const pushIf = (k, d)=>{ if (d!=null && Math.abs(d)>=5) items.push({k,v:d}); };
      pushIf('Office', pct(off0, off1));
      pushIf('Route',  pct(rm0, rm1));
      pushIf('Volume', pct(v0, v1));
      items.sort((a,b)=> Math.abs(b.v) - Math.abs(a.v));
      const top = items.slice(0,2);
      el.style.display = 'flex';
      if (!top.length){
        el.innerHTML = `<span class="pill"><small>Factors</small> <b style="color:var(--muted)">Similar</b></span>`;
      } else {
        el.innerHTML = top.map(it=> `<span class="pill"><small>${it.k}</small> <b style="color:${colorForDelta(it.v).fg}">${it.v>=0?'‚Üë '+it.v+'%':'‚Üì '+Math.abs(it.v)+'%'}</b></span>`).join('');
      }
    }catch(_){ /* no-op */ }
  }

  // Heaviness (today): attribute total-hours delta into Office vs Route (adjusted).
  function buildHeavinessToday(rows){
    rows = filterRowsForView(rows||[]);
    try{
      const el = document.getElementById('todayHeaviness'); if (!el) return;
      const now = DateTime.now().setZone(ZONE);
      const dow = now.weekday % 7;
      const worked = (rows||[]).filter(r=> r.status!=='off');
      const todayIso = now.toISODate();
      const todayRow = worked.find(r=> r.work_date === todayIso);
      if (!todayRow){ el.style.display='none'; return; }
      const offTodayH = (+todayRow.office_minutes||0)/60;
      const rteTodayH = Math.max(0, ((+todayRow.route_minutes||0) - boxholderAdjMinutes(todayRow)))/60;
      const totTodayH = (+todayRow.hours||0) || (offTodayH + rteTodayH);
      // Baselines by DOW
      const sameDow = worked.filter(r=> r.work_date !== todayIso && (dowIndex(r.work_date)===dow));
      const avg = (arr,fn)=>{ const v = arr.map(fn).filter(x=> x>0); return v.length? (v.reduce((a,b)=>a+b,0)/v.length) : null; };
      const offAvgH = avg(sameDow, r=> (+r.office_minutes||0)/60);
      const rteAvgH = avg(sameDow, r=> Math.max(0, ((+r.route_minutes||0)-boxholderAdjMinutes(r)))/60);
      const totAvgH = avg(sameDow, r=> (+r.hours||0));
      if (offAvgH==null && rteAvgH==null && totAvgH==null){ el.style.display='none'; return; }
      const dOff = (offAvgH==null)? null : (offTodayH - offAvgH);
      const dRte = (rteAvgH==null)? null : (rteTodayH - rteAvgH);
      const dTot = (totAvgH==null)? null : (totTodayH - totAvgH);
      const baseTot = (totAvgH && totAvgH>0)? totAvgH : ((offAvgH||0)+(rteAvgH||0))||null;
      const pct = (x)=> (x==null || !baseTot)? null : Math.round((x/baseTot)*100);
      const pill = (label,dh)=>{
        const p = pct(dh);
        const txt = (dh==null)? '‚Äî' : `${dh>=0?'+':''}${(Math.round(dh*10)/10).toFixed(1)}h`;
        const pTxt = (p==null)? '' : ` (${p>=0?'+':''}${p}%)`;
        const col = colorForDelta(p||0).fg;
        return `<span class="pill"><small>${label}</small> <b style="color:${col}">${txt}${pTxt}</b></span>`;
      };
      el.style.display='flex';
      el.innerHTML = [pill('Office', dOff), pill('Route', dRte), pill('Total', dTot)].join(' ');
    }catch(_){ /* no-op */ }
  }

  // Week Heaviness: attribution Mon..today vs last Mon..today (Office vs Route adjusted vs Total)
  function buildWeekHeaviness(rows){
    rows = filterRowsForView(rows||[]);
    try{
      const el = document.getElementById('weekHeaviness'); if (!el) return;
      const now = DateTime.now().setZone(ZONE);
      const startThis = startOfWeekMonday(now);
      const endThis   = now.endOf('day');
      const startLast = startOfWeekMonday(now.minus({weeks:1}));
      const lastEndSame = startOfWeekMonday(now.minus({weeks:1})).plus({days: now.weekday-1}).endOf('day');
      const inRange=(r,from,to)=>{ const d=DateTime.fromISO(r.work_date,{zone:ZONE}); return d>=from && d<=to; };
      const worked = (rows||[]).filter(r=> r.status!=='off');
      const W0 = worked.filter(r=> inRange(r,startThis,endThis));
      const W1 = worked.filter(r=> inRange(r,startLast,lastEndSame));
      const sum = (arr,fn)=> arr.reduce((t,x)=> t + (fn(x)||0), 0);
      const off0 = sum(W0, r=> +r.office_minutes||0)/60, off1 = sum(W1, r=> +r.office_minutes||0)/60;
      const rte0 = sum(W0, r=> Math.max(0, (+r.route_minutes||0) - boxholderAdjMinutes(r)))/60;
      const rte1 = sum(W1, r=> Math.max(0, (+r.route_minutes||0) - boxholderAdjMinutes(r)))/60;
      const tot0 = sum(W0, r=> +r.hours||0), tot1 = sum(W1, r=> +r.hours||0);
      const dOff = off0 - off1, dRte = rte0 - rte1, dTot = tot0 - tot1;
      const baseTot = (tot1>0)? tot1 : null;
      const pct = (x)=> (x==null || !baseTot)? null : Math.round((x/baseTot)*100);
      const pill = (label,dh)=>{
        const p = pct(dh);
        const txt = `${dh>=0?'+':''}${(Math.round(dh*10)/10).toFixed(1)}h`;
        const pTxt = (p==null)? '' : ` (${p>=0?'+':''}${p}%)`;
        const col = colorForDelta(p||0).fg;
        return `<span class="pill"><small>${label}</small> <b style="color:${col}">${txt}${pTxt}</b></span>`;
      };
      el.style.display='flex';
      el.innerHTML = [pill('Office', dOff), pill('Route', dRte), pill('Total', dTot)].join(' ');
    }catch(_){ /* no-op */ }
  }

  // Office Time Compare overlay (this week vs last)
  function buildOfficeCompare(rows){
    rows = filterRowsForView(rows||[]);
    try{
      const card = document.getElementById('officeCompareCard'); if (!card) return;
      const overlay = document.getElementById('officeOverlay');
      const summary = document.getElementById('officeSummary');
      const now = DateTime.now().setZone(ZONE);
      const startThis = startOfWeekMonday(now);
      const endThis   = now.endOf('day');
      const startLast = startOfWeekMonday(now.minus({weeks:1}));
      const endLast   = endOfWeekSunday(now.minus({weeks:1}));
      const lastEndSame = startOfWeekMonday(now.minus({weeks:1})).plus({days: now.weekday-1}).endOf('day');
      const inRange=(r,from,to)=>{ const d=DateTime.fromISO(r.work_date,{zone:ZONE}); return d>=from && d<=to; };
      const worked = (rows||[]).filter(r=> r.status!=='off');
      const W0 = worked.filter(r=> inRange(r,startThis,endThis));
      const W1 = worked.filter(r=> inRange(r,startLast,endLast));
      const sum = (arr,fn)=> arr.reduce((t,x)=> t + (fn(x)||0), 0);
      const offByDow = (arr)=>{ const a=Array.from({length:7},()=>0); arr.forEach(r=>{ const d=DateTime.fromISO(r.work_date,{zone:ZONE}); const idx=(d.weekday+6)%7; a[idx]+= (+r.office_minutes||0); }); return a.map(n=> +(Math.round(n*100)/100).toFixed(2)); };
      const thisBy = offByDow(W0);
      const lastBy = offByDow(W1);
      const dayIdxToday = (now.weekday + 6) % 7;
      const thisMasked = thisBy.map((v,i)=> i<=dayIdxToday? v : null);
      const days = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
      // Summary (Mon..today vs last Mon..today)
      const off0 = sum(W0.filter(r=> inRange(r,startThis, endThis && DateTime.fromJSDate(new Date()).setZone(ZONE))), r=> +r.office_minutes||0); // already filtered
      const off1same = sum(worked.filter(r=> inRange(r,startLast,lastEndSame)), r=> +r.office_minutes||0);
      const dPct = (off1same>0)? Math.round(((off0 - off1same)/off1same)*100) : null;
      if (summary) summary.textContent = `Office (so far): ${off0.toFixed(2)}h vs ${off1same.toFixed(2)}h (${dPct==null?'‚Äî':(dPct>=0?('‚Üë '+dPct+'%'):('‚Üì '+Math.abs(dPct)+'%'))})`;
      card.style.display='block';
      if (overlay && window.Chart && overlay.getContext){
        const ctx = overlay.getContext('2d');
        if (overlay._chart) { try{ overlay._chart.destroy(); }catch(_){ } }
        const brand = getComputedStyle(document.documentElement).getPropertyValue('--brand').trim()||'#2b7fff';
        const warn  = getComputedStyle(document.documentElement).getPropertyValue('--warn').trim() || '#FFD27A';
        overlay._chart = new Chart(ctx, {
          type:'line',
          data:{ labels:days, datasets:[
            { label:'Last week', data:lastBy, borderColor:brand, backgroundColor:'transparent', tension:0.25, pointRadius:3, pointHoverRadius:6, pointHitRadius:14, borderWidth:2, spanGaps:true },
            { label:'This week', data:thisMasked, borderColor:warn,  backgroundColor:'transparent', tension:0.25, pointRadius:3, pointHoverRadius:6, pointHitRadius:14, borderWidth:2, spanGaps:true }
          ]},
          options:{ responsive:true, maintainAspectRatio:false,
            layout:{ padding:{ top:12, right:16, bottom:10, left:16 } },
            interaction:{ mode:'nearest', intersect:false },
            plugins:{ legend:{ display:false }, tooltip:{
              callbacks:{
                title:(items)=> items && items[0]? items[0].label : '',
                label:(item)=>{
                  const i=item.dataIndex; const lw=lastBy[i]; const tw=thisBy[i];
                  const hasTw = i<=dayIdxToday && tw!=null;
                  return hasTw? `This: ${tw}h (Last: ${lw}h)` : `Last: ${lw}h`;
                }
              }
            }},
            scales:{ x:{ display:true, grid:{ display:false } }, y:{ display:false } }
          }
        });
      }
    }catch(_){ /* no-op */ }
  }

  // USPS tiles: Route Eff. vs eval, and Weekly $/h
  function buildUspsTiles(rows){
    try{
      rows = filterRowsForView(rows||[]);
      const routeTile = document.getElementById('tileUspsRouteEff');
      const hourlyTile= document.getElementById('tileUspsHourly');
      if (!routeTile || !hourlyTile) return;
      const show = !!(FLAGS && FLAGS.uspsEval);
      routeTile.style.display = show ? '' : 'none';
      hourlyTile.style.display= show ? '' : 'none';
      if (!show) return;
      const cfg = USPS_EVAL || loadEval();
      // Hours vs eval (this week, running total Mon..today) ‚Äî includes office time
      try{
        const now = DateTime.now().setZone(ZONE);
        const start = startOfWeekMonday(now);
        const end   = now.endOf('day');
        const inRange=(r)=>{ const d=DateTime.fromISO(r.work_date,{zone:ZONE}); return d>=start && d<=end; };
        const worked = (rows||[]).filter(r=> r.status!=='off' && inRange(r));
        const days = Array.from(new Set(worked.map(r=> r.work_date))).length;
        const valEl = document.getElementById('uspsRouteEffVal');
        if (!days || cfg.hoursPerDay==null){ valEl.textContent='‚Äî'; valEl.style.color=''; }
        else {
          const expHoursTotal = Math.max(0, cfg.hoursPerDay) * days;
          const hoursTotal = worked.reduce((t,r)=> t + (+r.hours||0), 0);
          const progress = (expHoursTotal>0) ? (hoursTotal / expHoursTotal) * 100 : null;
          if (progress==null || !isFinite(progress)) { valEl.textContent='‚Äî'; valEl.style.color=''; }
          else {
            const s = Math.round(progress);
            valEl.textContent = `${s}%`;
            valEl.style.color = '';
            valEl.title = `${(Math.round(hoursTotal*100)/100).toFixed(2)}h of ${(Math.round(expHoursTotal*100)/100).toFixed(2)}h eval over ${days} day(s)`;
          }
        }
      }catch(_){ /* ignore */ }
      // Weekly hourly rate ‚Äî 4-week rolling average of $/h
      try{
        const now = DateTime.now().setZone(ZONE);
        const weeksBack = 4;
        const ranges = [];
        for (let w=1; w<=weeksBack; w++){
          ranges.push({ s: startOfWeekMonday(now.minus({weeks:w})), e: endOfWeekSunday(now.minus({weeks:w})) });
        }
        const val = document.getElementById('uspsHourlyRateVal');
        if (!cfg || cfg.annualSalary==null){ val.textContent='‚Äî'; val.style.color=''; }
        else {
          const weeklyPay = cfg.annualSalary / 52;
          let totalHours = 0, usedWeeks = 0;
          for (const rg of ranges){
            const wk = (rows||[]).filter(r=> r.status!=='off' && (()=>{ const d=DateTime.fromISO(r.work_date,{zone:ZONE}); return d>=rg.s && d<=rg.e; })());
            const h = wk.reduce((t,r)=> t + (+r.hours||0), 0);
            if (h > 0){ totalHours += h; usedWeeks++; }
          }
          if (!usedWeeks || totalHours<=0){
            val.textContent='‚Äî'; val.style.color='';
          } else {
            // Weighted average across weeks: (usedWeeks * weeklyPay) / totalHours
            const rate = (usedWeeks * weeklyPay) / totalHours;
            val.textContent = `$${(Math.round(rate*100)/100).toFixed(2)}`;
            val.title = `${usedWeeks}wk avg: ${totalHours.toFixed(2)}h total`;
            val.style.color='';
          }
        }
      }catch(_){ /* ignore */ }
    }catch(_){ /* ignore */ }
  }

  // Quick Filter (Phase 3): weekday selector with stats + optional sparkline
  function buildQuickFilter(rows){
    rows = filterRowsForView(rows||[]);
    const card = document.getElementById('quickFilterCard');
    if (!card) return;
    card.style.display = FLAGS.quickFilter ? 'block' : 'none';
    if (!FLAGS.quickFilter) return;
    const sel = document.getElementById('qfSelect');
    const stats = document.getElementById('qfStats');
    const spark = document.getElementById('qfSpark');
    const text = document.getElementById('qfText');
    const cbAll = document.getElementById('qfAllMetrics');
    const cbP = document.getElementById('qfShowParcels');
    const cbL = document.getElementById('qfShowLetters');
    const cbH = document.getElementById('qfShowHours');
    const selN = document.getElementById('qfLastN');
    const cbRuler = document.getElementById('qfShowRuler');
    const normBadge = document.getElementById('qfNormBadge');
    if (!stats || !spark || !text) return;

    const dayVal = (sel && sel.value) || 'all';
    const worked = (rows||[]).filter(r=> r.status!=='off');
    const filtered = worked.filter(r=> dayVal==='all' ? true : (DateTime.fromISO(r.work_date,{zone:ZONE}).weekday%7) == +dayVal);

    const count = filtered.length;
    const sum = (arr,fn)=> arr.reduce((t,x)=> t + (fn(x)||0), 0);
    const avg = (arr,fn)=> arr.length? sum(arr,fn)/arr.length : null;
    const avgH = avg(filtered, r=> +r.hours||0);
    const avgP = avg(filtered, r=> +r.parcels||0);
    const avgL = avg(filtered, r=> +r.letters||0);
    const avgR = avg(filtered, r=> +r.route_minutes||0);

    // Pills
    const pill = (label,val,fmt)=> `<span class="pill"><small>${label}:</small> <b>${fmt(val)}</b></span>`;
    const nf = (v)=> v==null? '‚Äî' : (typeof v==='number'? (Math.round(v*100)/100).toString() : String(v));
    stats.innerHTML = [
      pill('Days', count, nf),
      pill('Avg hours', avgH, v=> v==null?'‚Äî':(Math.round(v*100)/100).toFixed(2)),
      pill('Avg parcels', avgP, v=> v==null?'‚Äî':Math.round(v)),
      pill('Avg letters', avgL, v=> v==null?'‚Äî':Math.round(v)),
      pill('Avg route min', avgR, v=> v==null?'‚Äî':Math.round(v))
    ].join('');

    // Viz: tiny line(s) over last up to 12 filtered entries
    const available = filtered.length;
    const lastCount = (selN && +selN.value) || +(localStorage.getItem('routeStats.qf.lastN')||12) || 12;
    if (selN) selN.value = String(lastCount);
    // Disable Last N options that exceed available points (per current filter)
    if (selN && selN.options) {
      try{
        Array.from(selN.options).forEach(o=>{ o.disabled = (+o.value) > available; });
      }catch(_){ /* no-op */ }
    }
    const lastN = filtered
      .slice()
      .sort((a,b)=> (a.work_date < b.work_date ? -1 : 1))
      .slice(-lastCount);
    const labels = lastN.map(r=> DateTime.fromISO(r.work_date,{zone:ZONE}).toFormat('LLL d'));
    // Restore persisted ruler preference once
    try{
      if (cbRuler && typeof buildQuickFilter._rulerInit === 'undefined'){
        const pref = localStorage.getItem('routeStats.qf.ruler');
        if (pref != null) cbRuler.checked = pref === '1';
        buildQuickFilter._rulerInit = true;
      }
    }catch(_){ /* ignore */ }

    const showP = cbP ? !!cbP.checked : true;
    const showL = cbL ? !!cbL.checked : true;
    const showH = cbH ? !!cbH.checked : true;
    if (cbAll) cbAll.checked = !!(showP && showL && showH);
    const serP = lastN.map(r=> +r.parcels||0);
    const serL = lastN.map(r=> +r.letters||0);
    const serH = lastN.map(r=> +r.hours||0);
    const brand = getComputedStyle(document.documentElement).getPropertyValue('--brand').trim()||'#2b7fff';
    const warn  = getComputedStyle(document.documentElement).getPropertyValue('--warn').trim() || '#FFD27A';
    const good  = getComputedStyle(document.documentElement).getPropertyValue('--good').trim() || '#2E7D32';
    const datasets = [];
    // Normalize if plotting multiple metrics to make lines comparable on the same sparkline
    const needNormalize = [showP, showL, showH].filter(Boolean).length > 1;
    const norm = (arr)=>{
      const vals = arr || [];
      let min = Infinity, max = -Infinity;
      for (const v of vals){ if (v==null) continue; if (v<min) min=v; if (v>max) max=v; }
      if (!isFinite(min) || !isFinite(max)) return vals.map(_=> null);
      if (max === min) return vals.map(_=> 50); // flat line mid if no variance
      return vals.map(v=> v==null? null : Math.round( ( (v - min) / (max - min) ) * 100 ));
    };
    const dataP = needNormalize ? norm(serP) : serP;
    const dataL = needNormalize ? norm(serL) : serL;
    const dataH = needNormalize ? norm(serH) : serH;
    if (showP) datasets.push({ label:'Parcels', data: dataP, borderColor:brand, backgroundColor:'transparent', tension:0.25, pointRadius:2, borderWidth:2, spanGaps:true });
    if (showL) datasets.push({ label:'Letters', data: dataL, borderColor:warn,  backgroundColor:'transparent', tension:0.25, pointRadius:2, borderWidth:2, spanGaps:true });
    if (showH) datasets.push({ label:'Hours',   data: dataH, borderColor:good,  backgroundColor:'transparent', tension:0.25, pointRadius:2, borderWidth:2, spanGaps:true });
    const summary = [];
    const fmtNum = (n)=> (Math.round(n*10)/10).toFixed(1);
    if (showP) summary.push(`P: ${serP.slice(-labels.length).map(fmtNum).join(', ')}`);
    if (showL) summary.push(`L: ${serL.slice(-labels.length).map(fmtNum).join(', ')}`);
    if (showH) summary.push(`H: ${serH.slice(-labels.length).map(fmtNum).join(', ')}`);
    const showing = labels.length;
    const requested = lastCount;
    const note = needNormalize ? ' (normalized)' : '';
    if (normBadge) normBadge.style.display = needNormalize ? 'inline-flex' : 'none';
    const coverage = `Showing ${showing} of ${requested} requested${available?`, available ${available}`:''}`;
    text.textContent = datasets.length ? `${summary.join(' ‚Ä¢ ')} ‚Äî ${coverage}${note}` : '‚Äî';
    // Days badge near legend
    const daysBadge = document.getElementById('qfDaysBadge');
    if (daysBadge){ daysBadge.style.display='inline-flex'; daysBadge.innerHTML = `<small>Days</small> <b>${count}</b>`; }

    if (window.Chart && spark.getContext){
      try{
        const ctx = spark.getContext('2d');
        if (spark._chart) { try{ spark._chart.destroy(); }catch(_){} }
        try{ spark.height = 64; }catch(_){ }
        const wantRuler = (cbRuler ? !!cbRuler.checked : false) && needNormalize;
        spark._chart = new Chart(ctx, {
          type:'line',
          data:{ labels, datasets: datasets.map(d => Object.assign({ tension:0.25, pointRadius:2, borderWidth:2, spanGaps:true, fill:false }, d)) },
          options:{
            responsive:true,
            maintainAspectRatio:false,
            layout:{ padding:{ top:8, right:6, bottom:6, left:6 } },
            interaction:{ mode:'nearest', intersect:false },
            plugins:{ legend:{ display:false }, tooltip:{ enabled:true } },
            scales:{
              x:{ display:false, grid:{ display:false } },
              y:{
                display: wantRuler,
                min: needNormalize ? 0 : undefined,
                max: needNormalize ? 100 : undefined,
                ticks:{ display:false, stepSize:50 },
                grid:{ display: wantRuler, color:'rgba(255,255,255,0.08)' }
              }
            }
          }
        });
      }catch(_){ /* fallback already set in text */ }
    }

    // Hook change
    const handler = ()=> buildQuickFilter(rows);
    // Rebind events
    sel?.removeEventListener('change', buildQuickFilter._handlerSel || (()=>{}));
    cbP?.removeEventListener('change', buildQuickFilter._handlerP || (()=>{}));
    cbL?.removeEventListener('change', buildQuickFilter._handlerL || (()=>{}));
    cbH?.removeEventListener('change', buildQuickFilter._handlerH || (()=>{}));
    selN?.removeEventListener('change', buildQuickFilter._handlerN || (()=>{}));
    cbAll?.removeEventListener('change', buildQuickFilter._handlerAll || (()=>{}));
    cbRuler?.removeEventListener('change', buildQuickFilter._handlerRuler || (()=>{}));
    buildQuickFilter._handlerSel = (e)=>{
      // Auto-expand Quick Filter when a day is selected and the section is collapsed
      try{
        if (FLAGS && FLAGS.collapsedUi){
          const body = document.querySelector('#quickFilterCard > .__collapseBody');
          if (body && body.style.display === 'none'){
            try{ (window.__collapse_set||(()=>{}))('quickFilterCard', false); }catch(_){ }
          }
        }
      }catch(_){ }
      handler();
    };
    buildQuickFilter._handlerP = handler;
    buildQuickFilter._handlerL = handler;
    buildQuickFilter._handlerH = handler;
    buildQuickFilter._handlerN = (e)=>{ try{ localStorage.setItem('routeStats.qf.lastN', String(e.target.value)); }catch(_){} handler(); };
    buildQuickFilter._handlerAll = ()=>{
      const on = !!cbAll.checked;
      if (cbP) cbP.checked = on;
      if (cbL) cbL.checked = on;
      if (cbH) cbH.checked = on;
      handler();
    };
    buildQuickFilter._handlerRuler = (e)=>{ try{ localStorage.setItem('routeStats.qf.ruler', e.target.checked ? '1' : '0'); }catch(_){} handler(); };
    sel?.addEventListener('change', buildQuickFilter._handlerSel);
    cbP?.addEventListener('change', handler);
    cbL?.addEventListener('change', handler);
    cbH?.addEventListener('change', handler);
    selN?.addEventListener('change', buildQuickFilter._handlerN);
    cbAll?.addEventListener('change', buildQuickFilter._handlerAll);
    cbRuler?.addEventListener('change', buildQuickFilter._handlerRuler);
  }
</script>
</body>
</html>
